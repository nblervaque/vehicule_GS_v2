<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi V√©hicules - Gaz Service</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 3px solid #ecf0f1;
            flex-wrap: wrap;
        }

        .tab {
            padding: 15px 25px;
            background: #ecf0f1;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 5px;
            margin-bottom: 5px;
            border-radius: 8px 8px 0 0;
        }

        .tab.active {
            background: #3498db;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .checkbox-item:hover {
            background: #e9ecef;
        }

        .checkbox-item.checked {
            background: #d4edda;
            border-color: #28a745;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .state-group {
            margin: 20px 0;
        }

        .state-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .state-item {
            display: flex;
            flex-direction: column;
        }

        .state-item select {
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            background: white;
            min-height: 48px;
        }

        .state-item select:focus {
            outline: none;
            border-color: #3498db;
        }

        .state-item label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .btn {
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
            transform: translateY(-2px);
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .controls-list {
            margin-top: 30px;
        }

        .control-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .control-item:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .control-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-weight: 600;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .info-value {
            color: #2c3e50;
            margin-top: 2px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-ok {
            background: #d4edda;
            color: #155724;
        }

        .status-missing {
            background: #f8d7da;
            color: #721c24;
        }

        .status-bon {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-moyen {
            background: #fff3cd;
            color: #856404;
        }

        .status-mauvais {
            background: #f8d7da;
            color: #721c24;
        }

        .no-data {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }

        .search-bar {
            margin-bottom: 20px;
        }

        .search-bar input {
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 1rem;
        }

        .backup-section {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .backup-section h4 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .backup-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            align-items: center;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            overflow: hidden;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 20px;
            background: #6c757d;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .file-input-label:hover {
            background: #5a6268;
        }

        /* Styles pour le module photo */
        .photo-section {
            margin: 30px 0;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px dashed #007bff;
        }

        .photo-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .photo-counter {
            font-weight: 600;
            color: #6c757d;
            background: #e9ecef;
            padding: 8px 12px;
            border-radius: 20px;
        }

        .photo-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .photo-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .photo-item:hover {
            transform: translateY(-2px);
        }

        .photo-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .photo-delete {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-delete:hover {
            background: #c0392b;
        }

        /* Modal cam√©ra */
        .camera-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .camera-content {
            background: white;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .camera-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #3498db;
            color: white;
            flex-shrink: 0;
        }

        .camera-header h4 {
            margin: 0;
        }

        .camera-body {
            padding: 15px 20px;
            text-align: center;
            flex: 1;
            overflow: auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .camera-body video {
            width: 100%;
            max-width: 450px;
            max-height: 60vh;
            border-radius: 8px;
            background: #000;
        }

        .camera-footer {
            padding: 15px 20px;
            text-align: center;
            background: #f8f9fa;
            flex-shrink: 0;
            border-top: 1px solid #dee2e6;
        }

        /* Affichage des photos dans l'historique */
        .control-photos {
            margin-top: 15px;
        }

        .control-photos h5 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }

        .photo-thumbnail {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .photo-thumbnail:hover {
            transform: scale(1.05);
        }

        /* Modal d'agrandissement des photos */
        .photo-viewer-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-viewer-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .photo-viewer-image {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
        }

        .photo-viewer-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* Styles pour l'export PDF */
        .pdf-filters {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .date-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .pdf-results {
            margin-top: 20px;
        }

        .pdf-control-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pdf-control-info {
            flex: 1;
        }

        .pdf-control-actions {
            display: flex;
            gap: 10px;
        }

        /* Styles pour le module d'alertes */
        .alert-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .alerts-list {
            margin-top: 20px;
        }

        .alert-item {
            background: white;
            border: 1px solid #dee2e6;
            border-left: 5px solid #dc3545;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            position: relative;
        }

        .alert-item:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .alert-item.resolved {
            border-left-color: #28a745;
            background: #f8fff9;
            opacity: 0.8;
        }

        .alert-item.critical {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .alert-item.warning {
            border-left-color: #ffc107;
            background: #fffdf0;
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .alert-title {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .alert-vehicle {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .alert-date {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .alert-severity {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .alert-severity.critical {
            background: #f8d7da;
            color: #721c24;
        }

        .alert-severity.warning {
            background: #fff3cd;
            color: #856404;
        }

        .alert-severity.resolved {
            background: #d4edda;
            color: #155724;
        }

        .alert-content {
            margin-bottom: 15px;
        }

        .alert-issues {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .alert-category {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 12px;
        }

        .alert-category h5 {
            margin: 0 0 8px 0;
            color: #495057;
            font-size: 0.9rem;
        }

        .alert-issue {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.85rem;
        }

        .alert-issue:last-child {
            border-bottom: none;
        }

        .issue-name {
            flex: 1;
            color: #495057;
        }

        .issue-status {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .issue-status.missing {
            background: #f8d7da;
            color: #721c24;
        }

        .issue-status.bad {
            background: #fff3cd;
            color: #856404;
        }

        .alert-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .alert-select {
            position: absolute;
            top: 15px;
            right: 15px;
        }

        .alert-select input[type="checkbox"] {
            transform: scale(1.2);
            cursor: pointer;
        }

        .alert-filters {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
        }

        .bulk-actions {
            background: #e3f2fd;
            border: 2px solid #bbdefb;
        }

        /* Styles pour le module de suivi d'avancement */
        .progress-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid transparent;
        }

        .stat-card.total {
            border-left-color: #3498db;
        }

        .stat-card.done {
            border-left-color: #27ae60;
        }

        .stat-card.pending {
            border-left-color: #e74c3c;
        }

        .stat-card.percent {
            border-left-color: #f39c12;
        }

        .stat-card.expired {
            border-left-color: #ff6b6b;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            transition: width 0.3s ease;
        }

        .vehicle-list {
            margin-top: 20px;
        }

        .vehicle-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .vehicle-item:hover {
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .vehicle-item.checked {
            background: #d4edda;
            border-color: #28a745;
        }

        .vehicle-item.pending {
            background: #fff5f5;
            border-color: #dc3545;
        }

        .vehicle-item.expired {
            background: #ffe6e6;
            border-color: #ff6b6b;
        }

        .vehicle-info {
            flex: 1;
        }

        .vehicle-immat {
            font-weight: bold;
            font-size: 1.1rem;
            color: #2c3e50;
        }

        .vehicle-details {
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 3px;
        }

        .vehicle-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .status-icon.done {
            background: #28a745;
        }

        .status-icon.pending {
            background: #dc3545;
        }

        .status-icon.expired {
            background: #ff6b6b;
        }

        .last-control-date {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .import-section {
            background: #f8f9fa;
            border: 2px dashed #007bff;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
        }

        .import-section.drag-over {
            border-color: #28a745;
            background: #f0fff4;
        }

        .import-instructions {
            color: #6c757d;
            margin-bottom: 20px;
        }

        .import-instructions h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .import-template {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            text-align: left;
        }

        .template-row {
            padding: 3px 0;
            border-bottom: 1px solid #f1f3f4;
        }

        .template-header {
            font-weight: bold;
            background: #f8f9fa;
            padding: 5px;
            margin: -5px;
        }

        /* Style pour les contr√¥les expir√©s */
        .expiry-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .expiry-info h5 {
            color: #856404;
            margin-bottom: 8px;
        }

        .expiry-info p {
            color: #856404;
            margin: 0;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }

        .warning-message {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #ffeaa7;
        }

        .info-message {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #bee5eb;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .main-content {
                padding: 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                margin-right: 0;
                border-radius: 8px;
            }

            .checkbox-group {
                grid-template-columns: 1fr;
            }

            .control-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .btn {
                width: 100%;
                margin: 5px 0;
            }

            .backup-controls {
                grid-template-columns: 1fr;
            }

            .photo-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .photo-preview {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 10px;
            }

            .camera-content {
                width: 95%;
                margin: 10px;
            }

            .camera-header {
                padding: 15px;
            }

            .camera-body {
                padding: 15px;
            }

            .photos-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }

            .photo-thumbnail {
                height: 60px;
            }

            .date-filters {
                grid-template-columns: 1fr;
            }

            .pdf-control-item {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .pdf-control-actions {
                justify-content: center;
            }

            .progress-stats {
                grid-template-columns: 1fr 1fr;
            }

            .vehicle-item {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .vehicle-status {
                justify-content: space-between;
            }

            .alert-stats {
                grid-template-columns: 1fr;
            }

            .alert-header {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .alert-actions {
                flex-direction: column;
            }

            .alert-issues {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöó Suivi des V√©hicules</h1>
            <p>Gaz Service - Contr√¥le et maintenance v3.0</p>
        </div>

        <div class="main-content">
            <div class="tabs">
                <button class="tab active" onclick="showTab('nouveau')">Nouveau Contr√¥le</button>
                <button class="tab" onclick="showTab('historique')">Historique</button>
                <button class="tab" onclick="showTab('alertes')">‚ö†Ô∏è Alertes</button>
                <button class="tab" onclick="showTab('avancement')">Suivi Avancement</button>
                <button class="tab" onclick="showTab('sauvegarde')">Sauvegarde</button>
                <button class="tab" onclick="showTab('export')">Export Excel</button>
                <button class="tab" onclick="showTab('pdf')">Export PDF</button>
            </div>

            <!-- Onglet Nouveau Contr√¥le -->
            <div id="nouveau" class="tab-content active">
                <form id="vehicleForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="conducteur">Nom du conducteur *</label>
                            <input type="text" id="conducteur" name="conducteur" required>
                        </div>
                        <div class="form-group">
                            <label for="dateControle">Date du contr√¥le *</label>
                            <input type="date" id="dateControle" name="dateControle" required>
                        </div>
                        <div class="form-group">
                            <label for="immatriculation">Immatriculation *</label>
                            <input type="text" id="immatriculation" name="immatriculation" placeholder="XX-XXX-XX" required>
                        </div>
                        <div class="form-group">
                            <label for="kilometrage">Kilom√©trage</label>
                            <input type="number" id="kilometrage" name="kilometrage" placeholder="123456">
                        </div>
                        <div class="form-group">
                            <label for="prochainControle">Prochain contr√¥le technique</label>
                            <input type="date" id="prochainControle" name="prochainControle">
                        </div>
                        <div class="form-group">
                            <label for="derniereRevision">Derni√®re r√©vision (km)</label>
                            <input type="number" id="derniereRevision" name="derniereRevision" placeholder="ex: 120000">
                        </div>
                        <div class="form-group">
                            <label for="commentaires">üí¨ Commentaires et observations</label>
                            <textarea id="commentaires" name="commentaires" rows="3" placeholder="Ajoutez vos observations, remarques ou notes concernant ce contr√¥le..."></textarea>
                        </div>
                    </div>

                    <h3>üìã Documents obligatoires</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="permis" name="permis">
                            <label for="permis">Permis de conduire</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="carteVerte" name="carteVerte">
                            <label for="carteVerte">Carte verte (assurance)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="carteGrise" name="carteGrise">
                            <label for="carteGrise">Carte grise</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="carteCarburant" name="carteCarburant">
                            <label for="carteCarburant">Carte carburant</label>
                        </div>
                    </div>

                    <h3>üõ°Ô∏è √âquipements de s√©curit√©</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="giletJaune" name="giletJaune">
                            <label for="giletJaune">Gilet jaune</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="triangle" name="triangle">
                            <label for="triangle">Triangle de signalisation</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="roueSecours" name="roueSecours">
                            <label for="roueSecours">Roue de secours</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="trousseSecours" name="trousseSecours">
                            <label for="trousseSecours">Trousse de secours</label>
                        </div>
                    </div>

                    <h3>üîß √âtat g√©n√©ral</h3>
                    <div class="state-group">
                        <div class="state-grid">
                            <div class="state-item">
                                <label>Rangement du v√©hicule</label>
                                <select name="etatRangement">
                                    <option value="bon">Bon</option>
                                    <option value="moyen">Moyen</option>
                                    <option value="mauvais">Mauvais</option>
                                </select>
                            </div>
                            <div class="state-item">
                                <label>Propret√© int√©rieur</label>
                                <select name="propret√©Interieur">
                                    <option value="bon">Bon</option>
                                    <option value="moyen">Moyen</option>
                                    <option value="mauvais">Mauvais</option>
                                </select>
                            </div>
                            <div class="state-item">
                                <label>Propret√© ext√©rieur</label>
                                <select name="propret√©Exterieur">
                                    <option value="bon">Bon</option>
                                    <option value="moyen">Moyen</option>
                                    <option value="mauvais">Mauvais</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <h3>üõû √âtat des pneus</h3>
                    <div class="state-group">
                        <div class="state-grid">
                            <div class="state-item">
                                <label>Pneu avant gauche</label>
                                <select name="pneuAvantGauche">
                                    <option value="bon">Bon</option>
                                    <option value="moyen">Moyen</option>
                                    <option value="mauvais">Mauvais</option>
                                </select>
                            </div>
                            <div class="state-item">
                                <label>Pneu avant droit</label>
                                <select name="pneuAvantDroit">
                                    <option value="bon">Bon</option>
                                    <option value="moyen">Moyen</option>
                                    <option value="mauvais">Mauvais</option>
                                </select>
                            </div>
                            <div class="state-item">
                                <label>Pneu arri√®re gauche</label>
                                <select name="pneuArriereGauche">
                                    <option value="bon">Bon</option>
                                    <option value="moyen">Moyen</option>
                                    <option value="mauvais">Mauvais</option>
                                </select>
                            </div>
                            <div class="state-item">
                                <label>Pneu arri√®re droit</label>
                                <select name="pneuArriereDroit">
                                    <option value="bon">Bon</option>
                                    <option value="moyen">Moyen</option>
                                    <option value="mauvais">Mauvais</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <h3>üì∏ Photos du contr√¥le</h3>
                    <div class="photo-section">
                        <p style="color: #6c757d; margin-bottom: 15px;">
                            Prenez jusqu'√† 5 photos pour documenter l'√©tat du v√©hicule
                        </p>
                        
                        <div class="photo-controls">
                            <button type="button" class="btn btn-info" onclick="openCamera()" id="cameraBtn">
                                üì± Prendre une photo
                            </button>
                            <span id="photoCount" class="photo-counter">0/5 photos</span>
                        </div>

                        <div id="photoPreview" class="photo-preview">
                            <!-- Photos will be displayed here -->
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button type="submit" class="btn btn-primary">üíæ Enregistrer le contr√¥le</button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">üîÑ R√©initialiser</button>
                    </div>
                </form>
            </div>

            <!-- Onglet Historique -->
            <div id="historique" class="tab-content">
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="üîç Rechercher par immatriculation, conducteur..." onkeyup="filterControls()">
                </div>
                <div id="controlsList" class="controls-list">
                    <div class="no-data">
                        <h3>Aucun contr√¥le enregistr√©</h3>
                        <p>Commencez par ajouter un nouveau contr√¥le</p>
                    </div>
                </div>
            </div>

            <!-- Onglet Alertes -->
            <div id="alertes" class="tab-content">
                <div style="padding: 20px;">
                    <h3>‚ö†Ô∏è Gestion des Alertes</h3>
                    <p style="margin: 15px 0; color: #6c757d;">
                        Suivi des anomalies d√©tect√©es lors des contr√¥les v√©hicules (√©l√©ments absents ou en mauvais √©tat).
                    </p>

                    <!-- Statistiques des alertes -->
                    <div class="alert-stats" id="alertStats" style="display: none;">
                        <div class="stat-card" style="border-left-color: #dc3545;">
                            <div class="stat-number" id="totalAlerts">0</div>
                            <div class="stat-label">Alertes actives</div>
                        </div>
                        <div class="stat-card" style="border-left-color: #28a745;">
                            <div class="stat-number" id="resolvedAlerts">0</div>
                            <div class="stat-label">Alertes r√©solues</div>
                        </div>
                        <div class="stat-card" style="border-left-color: #ffc107;">
                            <div class="stat-number" id="criticalAlerts">0</div>
                            <div class="stat-label">Alertes critiques</div>
                        </div>
                    </div>

                    <!-- Filtres -->
                    <div class="alert-filters" style="margin: 20px 0;">
                        <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                            <div class="form-group">
                                <label for="alertStatusFilter">Statut des alertes</label>
                                <select id="alertStatusFilter" onchange="filterAlerts()">
                                    <option value="all">Toutes les alertes</option>
                                    <option value="active" selected>Alertes actives</option>
                                    <option value="resolved">Alertes r√©solues</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="alertTypeFilter">Type d'alerte</label>
                                <select id="alertTypeFilter" onchange="filterAlerts()">
                                    <option value="all">Tous les types</option>
                                    <option value="document">Documents manquants</option>
                                    <option value="equipment">√âquipements manquants</option>
                                    <option value="condition">√âtats d√©grad√©s</option>
                                </select>
                            </div>
                            <div class="form-group" style="display: flex; align-items: end;">
                                <button class="btn btn-primary" onclick="refreshAlerts()">
                                    üîÑ Actualiser
                                </button>
                            </div>
                        </div>
                        
                        <div class="search-bar" style="margin-top: 15px;">
                            <input type="text" id="alertSearchInput" placeholder="üîç Rechercher par immatriculation, conducteur..." onkeyup="filterAlerts()">
                        </div>
                    </div>

                    <!-- Actions group√©es -->
                    <div class="bulk-actions" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; display: none;" id="bulkActions">
                        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                            <span style="font-weight: 600;">Actions group√©es :</span>
                            <button class="btn btn-success" onclick="resolveSelectedAlerts()">
                                ‚úÖ R√©soudre s√©lectionn√©es
                            </button>
                            <button class="btn btn-warning" onclick="unresolveSelectedAlerts()">
                                üîÑ R√©activer s√©lectionn√©es
                            </button>
                            <button class="btn btn-info" onclick="exportSelectedAlerts()">
                                üìä Exporter s√©lection
                            </button>
                            <span id="selectedCount" style="color: #6c757d; margin-left: auto;">0 alerte(s) s√©lectionn√©e(s)</span>
                        </div>
                    </div>

                    <!-- Liste des alertes -->
                    <div id="alertsList" class="alerts-list">
                        <div class="no-data">
                            <h3>Aucune alerte d√©tect√©e</h3>
                            <p>Parfait ! Tous les contr√¥les sont conformes.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Onglet Suivi Avancement -->
            <div id="avancement" class="tab-content">
                <div style="padding: 20px;">
                    <h3>üìä Suivi d'avancement des contr√¥les</h3>
                    <p style="margin: 15px 0; color: #6c757d;">
                        Importez votre liste de v√©hicules et suivez l'avancement des contr√¥les effectu√©s.
                    </p>

                    <!-- Information sur la r√®gle des 35 jours -->
                    <div class="expiry-info">
                        <h5>‚è∞ R√®gle de validit√© des contr√¥les</h5>
                        <p>Un contr√¥le n'est consid√©r√© comme "Contr√¥l√©" que s'il a √©t√© effectu√© dans les 35 derniers jours. Au-del√†, le v√©hicule repasse automatiquement au statut "En attente".</p>
                    </div>

                    <!-- Import de fichier Excel -->
                    <div class="import-section" id="importSection">
                        <div class="import-instructions">
                            <h4>üìã Importation de la liste des v√©hicules</h4>
                            <p>Glissez-d√©posez votre fichier Excel (.xlsx) ou cliquez pour le s√©lectionner</p>
                            <div class="import-template">
                                <div class="template-row template-header">Format attendu du fichier Excel :</div>
                                <div class="template-row">Colonne A : Immatriculation (ex: AB-123-CD)</div>
                                <div class="template-row">Colonne B : Marque (ex: Peugeot)</div>
                                <div class="template-row">Colonne C : Mod√®le (ex: 308)</div>
                            </div>
                        </div>
                        
                        <div class="file-input-wrapper">
                            <input type="file" id="vehicleListFile" accept=".xlsx,.xls" onchange="handleVehicleListFile(this)">
                            <label for="vehicleListFile" class="file-input-label">
                                üìÇ S√©lectionner le fichier Excel
                            </label>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <button class="btn btn-success" onclick="importVehicleList()" id="importBtn" disabled>
                                ‚¨ÜÔ∏è Importer la liste
                            </button>
                            <button class="btn btn-danger" onclick="clearVehicleList()">
                                üóëÔ∏è Vider la liste
                            </button>
                        </div>
                    </div>

                    <!-- Statistiques d'avancement -->
                    <div class="progress-stats" id="progressStats" style="display: none;">
                        <div class="stat-card total">
                            <div class="stat-number" id="totalVehicles">0</div>
                            <div class="stat-label">Total v√©hicules</div>
                        </div>
                        <div class="stat-card done">
                            <div class="stat-number" id="controlledVehicles">0</div>
                            <div class="stat-label">Contr√¥l√©s (< 35j)</div>
                        </div>
                        <div class="stat-card expired">
                            <div class="stat-number" id="expiredVehicles">0</div>
                            <div class="stat-label">Expir√©s (> 35j)</div>
                        </div>
                        <div class="stat-card pending">
                            <div class="stat-number" id="pendingVehicles">0</div>
                            <div class="stat-label">En attente</div>
                        </div>
                        <div class="stat-card percent">
                            <div class="stat-number" id="completionPercent">0%</div>
                            <div class="stat-label">Avancement</div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Liste des v√©hicules -->
                    <div id="vehicleListContainer" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h4>üöó Liste des v√©hicules</h4>
                            <button class="btn btn-success" onclick="exportProgressToExcel()">
                                üìä Exporter le suivi
                            </button>
                        </div>
                        
                        <div class="search-bar">
                            <input type="text" id="vehicleSearchInput" placeholder="üîç Rechercher un v√©hicule..." onkeyup="filterVehicleList()">
                        </div>
                        
                        <div id="vehicleList" class="vehicle-list">
                            <!-- Liste des v√©hicules sera g√©n√©r√©e ici -->
                        </div>
                    </div>

                    <div id="progressStatus"></div>
                </div>
            </div>

            <!-- Onglet Sauvegarde -->
            <div id="sauvegarde" class="tab-content">
                <div style="padding: 20px;">
                    <h3>üíæ Gestion des sauvegardes</h3>
                    <p style="margin: 15px 0; color: #6c757d;">
                        Prot√©gez vos donn√©es en cr√©ant des sauvegardes r√©guli√®res. Les sauvegardes sont stock√©es dans IndexedDB pour une capacit√© illimit√©e.
                    </p>

                    <!-- Information sur IndexedDB -->
                    <div class="info-message" style="margin: 20px 0;">
                        <strong>üìä Stockage avanc√© :</strong> Les sauvegardes utilisent IndexedDB pour stocker toutes vos photos sans limite de taille, contrairement aux anciens syst√®mes limit√©s √† 5-10MB.
                    </div>

                    <!-- Sauvegarde automatique -->
                    <div class="backup-section">
                        <h4>üîÑ Sauvegarde automatique</h4>
                        <p style="margin-bottom: 15px; color: #6c757d;">
                            Une sauvegarde automatique est cr√©√©e √† chaque modification des donn√©es et stock√©e en IndexedDB.
                        </p>
                        <div class="backup-controls">
                            <div>
                                <button class="btn btn-info" onclick="downloadAutoBackup()">
                                    üìã T√©l√©charger la sauvegarde auto
                                </button>
                            </div>
                            <div>
                                <button class="btn btn-secondary" onclick="listAllBackupsUI()">
                                    üìÅ Lister toutes les sauvegardes
                                </button>
                            </div>
                        </div>
                        <div id="autoBackupStatus"></div>
                    </div>

                    <!-- Sauvegarde manuelle -->
                    <div class="backup-section">
                        <h4>üíæ Sauvegarde manuelle</h4>
                        <p style="margin-bottom: 15px; color: #6c757d;">
                            Cr√©ez une sauvegarde compl√®te de toutes vos donn√©es avec toutes les photos incluses.
                        </p>
                        <div class="backup-controls">
                            <div>
                                <button class="btn btn-success" onclick="createManualBackup()">
                                    üíæ Cr√©er une sauvegarde
                                </button>
                            </div>
                            <div id="manualBackupStatus"></div>
                        </div>
                    </div>

                    <!-- Restauration -->
                    <div class="backup-section">
                        <h4>üìÇ Restaurer une sauvegarde</h4>
                        <div class="warning-message" style="margin-bottom: 15px;">
                            ‚ö†Ô∏è Attention : La restauration effacera toutes les donn√©es actuelles.
                        </div>
                        <div class="backup-controls">
                            <div class="file-input-wrapper">
                                <input type="file" id="backupFile" accept=".json" onchange="handleBackupFile(this)">
                                <label for="backupFile" class="file-input-label">
                                    üìÅ S√©lectionner un fichier de sauvegarde
                                </label>
                            </div>
                            <div>
                                <button class="btn btn-warning" onclick="restoreBackup()" id="restoreBtn" disabled>
                                    üîÑ Restaurer la sauvegarde
                                </button>
                            </div>
                        </div>
                        <div id="restoreStatus"></div>
                    </div>

                    <!-- Liste des sauvegardes -->
                    <div id="backupsList" style="margin-top: 30px; display: none;">
                        <h4>üìö Historique des sauvegardes</h4>
                        <div id="backupsListContent"></div>
                    </div>
                </div>
            </div>

            <!-- Onglet Export -->
            <div id="export" class="tab-content">
                <div style="text-align: center; padding: 40px;">
                    <h3>üìä Exporter les donn√©es</h3>
                    <p style="margin: 20px 0;">T√©l√©chargez tous les contr√¥les au format Excel (XLSX)</p>
                    <div class="loading" id="exportLoading">
                        <div class="spinner"></div>
                        <p>G√©n√©ration du fichier Excel...</p>
                    </div>
                    <button class="btn btn-success" onclick="exportToExcel()">üì• T√©l√©charger Excel</button>
                    <div id="exportStatus"></div>
                </div>
            </div>

            <!-- Onglet Export PDF -->
            <div id="pdf" class="tab-content">
                <div style="padding: 20px;">
                    <h3>üìÑ Export PDF des contr√¥les</h3>
                    <p style="margin: 15px 0; color: #6c757d;">
                        G√©n√©rez des rapports PDF individuels pour chaque contr√¥le.
                    </p>

                    <!-- Filtres -->
                    <div class="pdf-filters">
                        <h4>üìÖ Filtres de p√©riode</h4>
                        <div class="date-filters">
                            <div class="form-group">
                                <label for="pdfDateDebut">Date de d√©but</label>
                                <input type="date" id="pdfDateDebut" name="pdfDateDebut">
                            </div>
                            <div class="form-group">
                                <label for="pdfDateFin">Date de fin</label>
                                <input type="date" id="pdfDateFin" name="pdfDateFin">
                            </div>
                            <div class="form-group" style="display: flex; align-items: end;">
                                <button class="btn btn-primary" onclick="filterControlsForPDF()">
                                    üîç Filtrer les contr√¥les
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- R√©sultats -->
                    <div id="pdfResults" class="pdf-results" style="display: none;">
                        <h4>üìã Contr√¥les trouv√©s</h4>
                        <div id="pdfControlsList"></div>
                    </div>

                    <div class="loading" id="pdfLoading">
                        <div class="spinner"></div>
                        <p>G√©n√©ration du PDF en cours...</p>
                    </div>

                    <div id="pdfStatus"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="cameraModal" class="camera-modal" style="display: none;">
        <div class="camera-content">
            <div class="camera-header">
                <h4>üì∏ Prendre une photo</h4>
                <button type="button" class="btn btn-danger" onclick="closeCamera()">‚úñ Fermer</button>
            </div>
            <div class="camera-body">
                <video id="cameraVideo" autoplay playsinline></video>
                <canvas id="photoCanvas" style="display: none;"></canvas>
            </div>
            <div class="camera-footer">
                <button type="button" class="btn btn-primary" onclick="takePhoto()">
                    üì∏ Capturer
                </button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let db;
        const DB_NAME = 'GazServiceVehicules';
        const DB_VERSION = 3;
        const STORE_NAME = 'controles';
        const VEHICLE_STORE_NAME = 'vehicules';
        const ALERT_STORE_NAME = 'alertes';
        const BACKUP_STORE_NAME = 'sauvegardes'; // NOUVEAU STORE POUR SAUVEGARDES
        let selectedBackupFile = null;
        let currentPhotos = [];
        let cameraStream = null;
        const MAX_PHOTOS = 5;
        let filteredControlsForPDF = [];
        let vehicleList = [];
        let selectedVehicleFile = null;
        let currentAlerts = [];
        const CONTROL_EXPIRY_DAYS = 35;

        // Fonction utilitaire pour calculer la diff√©rence en jours
        function daysDifference(dateString) {
            if (!dateString) return Infinity;
            const controlDate = new Date(dateString);
            const today = new Date();
            const diffTime = today.getTime() - controlDate.getTime();
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        // Fonction pour v√©rifier si un contr√¥le est valide (moins de 35 jours)
        function isControlValid(controlDate) {
            return daysDifference(controlDate) <= CONTROL_EXPIRY_DAYS;
        }

        // === INITIALISATION DE LA BASE DE DONN√âES AVEC INDEXEDDB POUR SAUVEGARDES ===
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    
                    // Store pour les contr√¥les
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, { 
                            keyPath: 'id', 
                            autoIncrement: true 
                        });
                        store.createIndex('immatriculation', 'immatriculation', { unique: false });
                        store.createIndex('dateControle', 'dateControle', { unique: false });
                        store.createIndex('conducteur', 'conducteur', { unique: false });
                    }
                    
                    // Store pour les v√©hicules
                    if (!db.objectStoreNames.contains(VEHICLE_STORE_NAME)) {
                        const vehicleStore = db.createObjectStore(VEHICLE_STORE_NAME, { 
                            keyPath: 'immatriculation'
                        });
                        vehicleStore.createIndex('marque', 'marque', { unique: false });
                        vehicleStore.createIndex('modele', 'modele', { unique: false });
                    }
                    
                    // Store pour les alertes
                    if (!db.objectStoreNames.contains(ALERT_STORE_NAME)) {
                        const alertStore = db.createObjectStore(ALERT_STORE_NAME, { 
                            keyPath: 'id', 
                            autoIncrement: true 
                        });
                        alertStore.createIndex('controlId', 'controlId', { unique: false });
                        alertStore.createIndex('immatriculation', 'immatriculation', { unique: false });
                        alertStore.createIndex('status', 'status', { unique: false });
                        alertStore.createIndex('severity', 'severity', { unique: false });
                        alertStore.createIndex('type', 'type', { unique: false });
                    }
                    
                    // NOUVEAU : Store pour les sauvegardes
                    if (!db.objectStoreNames.contains(BACKUP_STORE_NAME)) {
                        const backupStore = db.createObjectStore(BACKUP_STORE_NAME, { 
                            keyPath: 'id', 
                            autoIncrement: true 
                        });
                        backupStore.createIndex('type', 'type', { unique: false });
                        backupStore.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                };
            });
        }

        // === FONCTIONS DE GESTION DES SAUVEGARDES EN INDEXEDDB ===

        // Sauvegarder une sauvegarde dans IndexedDB
        function saveBackupToDB(backupData) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([BACKUP_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(BACKUP_STORE_NAME);
                const request = store.add(backupData);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // R√©cup√©rer la derni√®re sauvegarde automatique
        function getLatestAutoBackup() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([BACKUP_STORE_NAME], 'readonly');
                const store = transaction.objectStore(BACKUP_STORE_NAME);
                const index = store.index('type');
                const request = index.openCursor('auto', 'prev'); // Plus r√©cent en premier
                
                request.onsuccess = () => {
                    const cursor = request.result;
                    resolve(cursor ? cursor.value : null);
                };
                request.onerror = () => reject(request.error);
            });
        }

        // R√©cup√©rer toutes les sauvegardes
        function getAllBackups() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([BACKUP_STORE_NAME], 'readonly');
                const store = transaction.objectStore(BACKUP_STORE_NAME);
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Supprimer les anciennes sauvegardes automatiques (garder seulement les 5 plus r√©centes)
        function cleanupOldAutoBackups() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([BACKUP_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(BACKUP_STORE_NAME);
                const index = store.index('type');
                const request = index.openCursor('auto', 'prev');
                
                let count = 0;
                const toDelete = [];
                
                request.onsuccess = () => {
                    const cursor = request.result;
                    if (cursor) {
                        count++;
                        if (count > 5) { // Garder seulement les 5 plus r√©centes
                            toDelete.push(cursor.value.id);
                        }
                        cursor.continue();
                    } else {
                        // Supprimer les anciennes sauvegardes
                        Promise.all(toDelete.map(id => {
                            return new Promise((res, rej) => {
                                const deleteReq = store.delete(id);
                                deleteReq.onsuccess = () => res();
                                deleteReq.onerror = () => rej(deleteReq.error);
                            });
                        })).then(() => resolve()).catch(reject);
                    }
                };
                request.onerror = () => reject(request.error);
            });
        }

        // Fonction utilitaire pour formater la taille en octets
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        // Version corrig√©e de createAutoBackup utilisant IndexedDB
        async function createAutoBackup() {
            try {
                console.log('D√©but cr√©ation sauvegarde automatique en IndexedDB...');
                
                // R√©cup√©ration des donn√©es avec gestion d'erreurs individuelle
                let controls = [];
                let vehicles = [];
                let alerts = [];
                
                try {
                    controls = await getAllControls();
                    console.log(`${controls.length} contr√¥les r√©cup√©r√©s`);
                } catch (error) {
                    console.error('Erreur r√©cup√©ration contr√¥les:', error);
                }
                
                try {
                    vehicles = await getVehicleList();
                    console.log(`${vehicles.length} v√©hicules r√©cup√©r√©s`);
                } catch (error) {
                    console.error('Erreur r√©cup√©ration v√©hicules:', error);
                }
                
                try {
                    alerts = await getAllAlerts();
                    console.log(`${alerts.length} alertes r√©cup√©r√©es`);
                } catch (error) {
                    console.error('Erreur r√©cup√©ration alertes:', error);
                }
                
                // Calcul des statistiques
                const totalPhotos = controls.reduce((sum, c) => sum + (c.photos ? c.photos.length : 0), 0);
                const estimatedPhotoSize = controls.reduce((sum, c) => {
                    if (c.photos) {
                        return sum + c.photos.reduce((photoSum, p) => photoSum + (p.data ? p.data.length : 0), 0);
                    }
                    return sum;
                }, 0);
                
                // Cr√©ation de l'objet de sauvegarde
                const backupData = {
                    version: '3.0',
                    timestamp: new Date().toISOString(),
                    type: 'auto',
                    data: {
                        controls: controls,
                        vehicles: vehicles,
                        alerts: alerts
                    },
                    stats: {
                        totalControls: controls.length,
                        totalVehicles: vehicles.length,
                        totalAlerts: alerts.length,
                        activeAlerts: alerts.filter(a => a.status === 'active').length,
                        totalPhotos: totalPhotos,
                        estimatedPhotoSize: formatBytes(estimatedPhotoSize)
                    },
                    integrity: {
                        controlsChecksum: controls.length > 0 ? btoa(JSON.stringify(controls.map(c => c.id || c.dateCreation))).slice(0, 20) : null,
                        vehiclesChecksum: vehicles.length > 0 ? btoa(JSON.stringify(vehicles.map(v => v.immatriculation))).slice(0, 20) : null,
                        alertsChecksum: alerts.length > 0 ? btoa(JSON.stringify(alerts.map(a => a.id || a.dateCreated))).slice(0, 20) : null
                    }
                };
                
                console.log(`Taille de la sauvegarde: ${formatBytes(JSON.stringify(backupData).length)}, ${totalPhotos} photos`);
                
                // Sauvegarder en IndexedDB
                await saveBackupToDB(backupData);
                
                // Nettoyer les anciennes sauvegardes automatiques
                await cleanupOldAutoBackups();
                
                console.log('Sauvegarde automatique cr√©√©e avec succ√®s en IndexedDB');
                
                // Mettre √† jour l'interface si possible
                const statusEl = document.getElementById('autoBackupStatus');
                if (statusEl) {
                    statusEl.innerHTML = `
                        <div class="success-message">
                            Sauvegarde auto cr√©√©e: ${controls.length} contr√¥les, ${vehicles.length} v√©hicules, ${alerts.length} alertes, ${totalPhotos} photos<br>
                            Cr√©√©e le: ${new Date().toLocaleString('fr-FR')}<br>
                            Stock√©e en IndexedDB (${formatBytes(JSON.stringify(backupData).length)})
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Erreur lors de la sauvegarde automatique:', error);
                
                // Notifier l'utilisateur en cas d'erreur critique
                const statusEl = document.getElementById('autoBackupStatus');
                if (statusEl) {
                    statusEl.innerHTML = `<div class="error-message">Erreur sauvegarde auto: ${error.message}</div>`;
                }
                
                // En cas d'erreur, essayer une sauvegarde minimale en localStorage comme fallback
                try {
                    const fallbackData = {
                        version: '3.0',
                        timestamp: new Date().toISOString(),
                        type: 'auto-fallback-localStorage',
                        data: { controls: [], vehicles: [], alerts: [] },
                        error: error.message,
                        note: 'Sauvegarde de secours en localStorage - IndexedDB indisponible'
                    };
                    localStorage.setItem('gazservice_auto_backup_fallback', JSON.stringify(fallbackData));
                    console.log('Sauvegarde de secours cr√©√©e en localStorage');
                } catch (fallbackError) {
                    console.error('Impossible de cr√©er m√™me une sauvegarde de secours:', fallbackError);
                }
            }
        }

        // Version corrig√©e de downloadAutoBackup utilisant IndexedDB
        async function downloadAutoBackup() {
            const statusEl = document.getElementById('autoBackupStatus');
            
            try {
                statusEl.innerHTML = '<div class="info-message">R√©cup√©ration de la sauvegarde automatique...</div>';
                
                // Essayer d'abord la sauvegarde IndexedDB
                let backupData = await getLatestAutoBackup();
                let filename = `GazService_AutoBackup_${new Date().toISOString().split('T')[0]}.json`;
                let source = 'IndexedDB';
                
                if (!backupData) {
                    // Fallback vers localStorage si n√©cessaire
                    const localStorageData = localStorage.getItem('gazservice_auto_backup_fallback');
                    if (localStorageData) {
                        backupData = JSON.parse(localStorageData);
                        filename = `GazService_AutoBackup_Fallback_${new Date().toISOString().split('T')[0]}.json`;
                        source = 'localStorage (fallback)';
                    } else {
                        statusEl.innerHTML = '<div class="error-message">Aucune sauvegarde automatique disponible</div>';
                        return;
                    }
                }
                
                // V√©rification de l'int√©grit√© des donn√©es
                if (!backupData.data || typeof backupData.data !== 'object') {
                    throw new Error('Structure de sauvegarde invalide');
                }
                
                const controls = backupData.data.controls || [];
                const vehicles = backupData.data.vehicles || [];
                const alerts = backupData.data.alerts || [];
                
                console.log(`T√©l√©chargement sauvegarde depuis ${source}: ${controls.length} contr√¥les, ${vehicles.length} v√©hicules, ${alerts.length} alertes`);
                
                // Ajouter des informations de diagnostic au fichier
                const enhancedData = {
                    ...backupData,
                    downloadInfo: {
                        downloadDate: new Date().toISOString(),
                        downloadedFrom: source,
                        dataSize: formatBytes(JSON.stringify(backupData).length),
                        browser: navigator.userAgent,
                        indexedDBAvailable: !!window.indexedDB
                    }
                };
                
                downloadJSON(enhancedData, filename);
                
                const photoInfo = backupData.stats && backupData.stats.totalPhotos ? 
                    `, ${backupData.stats.totalPhotos} photos (${backupData.stats.estimatedPhotoSize})` : '';
                
                statusEl.innerHTML = `
                    <div class="success-message">
                        Sauvegarde automatique t√©l√©charg√©e avec succ√®s !<br>
                        Source: ${source}<br>
                        ${controls.length} contr√¥les, ${vehicles.length} v√©hicules, ${alerts.length} alertes${photoInfo}<br>
                        Cr√©√©e le: ${new Date(backupData.timestamp).toLocaleString('fr-FR')}
                    </div>
                `;
                
            } catch (error) {
                console.error('Erreur t√©l√©chargement sauvegarde:', error);
                statusEl.innerHTML = `<div class="error-message">Erreur lors du t√©l√©chargement : ${error.message}</div>`;
            }
        }

        // Fonction pour lister toutes les sauvegardes disponibles
        async function listAllBackups() {
            try {
                const backups = await getAllBackups();
                backups.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                console.log('Sauvegardes disponibles en IndexedDB:');
                backups.forEach((backup, index) => {
                    const controls = backup.data.controls ? backup.data.controls.length : 0;
                    const vehicles = backup.data.vehicles ? backup.data.vehicles.length : 0;
                    const alerts = backup.data.alerts ? backup.data.alerts.length : 0;
                    const photos = backup.stats ? backup.stats.totalPhotos || 0 : 0;
                    
                    console.log(`${index + 1}. ${backup.type} - ${new Date(backup.timestamp).toLocaleString('fr-FR')} - ${controls}C/${vehicles}V/${alerts}A/${photos}P`);
                });
                
                return backups;
            } catch (error) {
                console.error('Erreur lors de la liste des sauvegardes:', error);
                return [];
            }
        }

        // Fonction pour afficher les sauvegardes dans l'UI
        async function listAllBackupsUI() {
            try {
                const backups = await listAllBackups();
                const listContainer = document.getElementById('backupsList');
                const listContent = document.getElementById('backupsListContent');
                
                if (backups.length === 0) {
                    listContent.innerHTML = '<div class="info-message">Aucune sauvegarde trouv√©e en IndexedDB</div>';
                } else {
                    listContent.innerHTML = backups.map((backup, index) => {
                        const controls = backup.data.controls ? backup.data.controls.length : 0;
                        const vehicles = backup.data.vehicles ? backup.data.vehicles.length : 0;
                        const alerts = backup.data.alerts ? backup.data.alerts.length : 0;
                        const photos = backup.stats ? backup.stats.totalPhotos || 0 : 0;
                        const size = formatBytes(JSON.stringify(backup).length);
                        
                        return `
                            <div class="backup-section" style="margin-bottom: 15px; padding: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${backup.type === 'auto' ? 'üîÑ Auto' : 'üíæ Manuelle'}</strong> - 
                                        ${new Date(backup.timestamp).toLocaleString('fr-FR')}<br>
                                        <small>${controls}C / ${vehicles}V / ${alerts}A / ${photos}P - ${size}</small>
                                    </div>
                                    <button class="btn btn-info" onclick="downloadSpecificBackup(${backup.id})" style="padding: 8px 15px;">
                                        üì• T√©l√©charger
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                listContainer.style.display = 'block';
                
            } catch (error) {
                console.error('Erreur affichage sauvegardes:', error);
                showMessage('error', 'Erreur lors de l\'affichage des sauvegardes : ' + error.message);
            }
        }

        // Fonction pour t√©l√©charger une sauvegarde sp√©cifique
        async function downloadSpecificBackup(backupId) {
            try {
                const transaction = db.transaction([BACKUP_STORE_NAME], 'readonly');
                const store = transaction.objectStore(BACKUP_STORE_NAME);
                const request = store.get(backupId);
                
                request.onsuccess = () => {
                    const backup = request.result;
                    if (backup) {
                        const filename = `GazService_Backup_${backup.type}_${new Date(backup.timestamp).toISOString().split('T')[0]}.json`;
                        downloadJSON(backup, filename);
                        showMessage('success', `Sauvegarde t√©l√©charg√©e : ${filename}`);
                    } else {
                        showMessage('error', 'Sauvegarde introuvable');
                    }
                };
                
                request.onerror = () => {
                    showMessage('error', 'Erreur lors du t√©l√©chargement');
                };
                
            } catch (error) {
                showMessage('error', 'Erreur : ' + error.message);
            }
        }

        // Version am√©lior√©e de createManualBackup
        async function createManualBackup() {
            const statusEl = document.getElementById('manualBackupStatus');
            
            try {
                statusEl.innerHTML = '<div class="info-message">Cr√©ation de la sauvegarde en cours...</div>';
                
                const controls = await getAllControls();
                const vehicles = await getVehicleList();
                const alerts = await getAllAlerts();
                
                // Calculer la taille avec photos
                const totalPhotos = controls.reduce((sum, c) => sum + (c.photos ? c.photos.length : 0), 0);
                const estimatedSizeWithPhotos = controls.reduce((sum, c) => {
                    if (c.photos) {
                        return sum + c.photos.reduce((photoSum, p) => photoSum + (p.data ? p.data.length : 0), 0);
                    }
                    return sum;
                }, 0);
                
                console.log(`Sauvegarde manuelle: ${totalPhotos} photos, taille estim√©e: ${formatBytes(estimatedSizeWithPhotos)}`);
                
                const backupData = {
                    version: '3.0',
                    timestamp: new Date().toISOString(),
                    type: 'manual',
                    data: {
                        controls: controls,
                        vehicles: vehicles,
                        alerts: alerts
                    },
                    stats: {
                        totalControls: controls.length,
                        totalVehicles: vehicles.length,
                        totalAlerts: alerts.length,
                        activeAlerts: alerts.filter(a => a.status === 'active').length,
                        totalPhotos: totalPhotos,
                        estimatedPhotoSize: formatBytes(estimatedSizeWithPhotos),
                        dateRange: controls.length > 0 ? {
                            earliest: new Date(Math.min(...controls.map(c => new Date(c.dateControle).getTime()))).toISOString(),
                            latest: new Date(Math.max(...controls.map(c => new Date(c.dateControle).getTime()))).toISOString()
                        } : null
                    },
                    integrity: {
                        controlsChecksum: controls.length > 0 ? btoa(JSON.stringify(controls.map(c => c.id || c.dateCreation))).slice(0, 20) : null,
                        vehiclesChecksum: vehicles.length > 0 ? btoa(JSON.stringify(vehicles.map(v => v.immatriculation))).slice(0, 20) : null,
                        alertsChecksum: alerts.length > 0 ? btoa(JSON.stringify(alerts.map(a => a.id || a.dateCreated))).slice(0, 20) : null
                    }
                };
                
                const filename = `GazService_Backup_${new Date().toISOString().replace(/[:.]/g, '-').split('T')[0]}.json`;
                
                // Sauvegarder aussi en IndexedDB
                await saveBackupToDB(backupData);
                
                downloadJSON(backupData, filename);
                statusEl.innerHTML = `
                    <div class="success-message">
                        Sauvegarde cr√©√©e et t√©l√©charg√©e : ${filename}<br>
                        ${controls.length} contr√¥les, ${vehicles.length} v√©hicules, ${alerts.length} alertes<br>
                        ${totalPhotos} photos incluses (${formatBytes(estimatedSizeWithPhotos)})<br>
                        √âgalement sauvegard√©e en IndexedDB
                    </div>
                `;
                
            } catch (error) {
                console.error('Erreur cr√©ation sauvegarde manuelle:', error);
                statusEl.innerHTML = '<div class="error-message">Erreur lors de la cr√©ation de la sauvegarde : ' + error.message + '</div>';
            }
        }

        // Fonction de diagnostic IndexedDB
        async function diagnoseIndexedDB() {
            try {
                if (!window.indexedDB) {
                    return { available: false, error: 'IndexedDB not supported' };
                }
                
                // Tester l'ouverture de la base
                const testDB = await new Promise((resolve, reject) => {
                    const request = indexedDB.open('test_db', 1);
                    request.onsuccess = () => {
                        request.result.close();
                        resolve(true);
                    };
                    request.onerror = () => reject(request.error);
                    request.onblocked = () => reject(new Error('IndexedDB blocked'));
                });
                
                // Estimer l'utilisation
                let usage = { available: true };
                if (navigator.storage && navigator.storage.estimate) {
                    const estimate = await navigator.storage.estimate();
                    usage.quota = estimate.quota;
                    usage.used = estimate.usage;
                    usage.available = estimate.quota - estimate.usage;
                    usage.percentUsed = ((estimate.usage / estimate.quota) * 100).toFixed(2);
                }
                
                console.log('IndexedDB disponible. Usage:', usage);
                return usage;
                
            } catch (error) {
                console.error('IndexedDB non disponible:', error);
                return { available: false, error: error.message };
            }
        }

        // Sauvegarder un contr√¥le
        async function saveControl(data) {
            return new Promise(async (resolve, reject) => {
                try {
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.add(data);
                    
                    request.onsuccess = async () => {
                        resolve(request.result);
                        
                        // Sauvegarde automatique en arri√®re-plan
                        createAutoBackup().catch(error => {
                            console.error('Erreur sauvegarde automatique apr√®s ajout contr√¥le:', error);
                        });
                        
                        // G√©n√©rer automatiquement les alertes apr√®s sauvegarde
                        generateAlertsFromControls().catch(error => {
                            console.error('Erreur lors de la g√©n√©ration des alertes:', error);
                        });
                        
                        if (document.getElementById('avancement').classList.contains('active')) {
                            loadVehicleProgress();
                        }
                    };
                    request.onerror = () => reject(request.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        // R√©cup√©rer tous les contr√¥les
        function getAllControls() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Supprimer un contr√¥le
        function deleteControl(id) {
            return new Promise(async (resolve, reject) => {
                try {
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.delete(id);
                    
                    request.onsuccess = async () => {
                        // Supprimer les alertes associ√©es
                        try {
                            await deleteAlertsByControlId(id);
                        } catch (error) {
                            console.error('Erreur lors de la suppression des alertes:', error);
                        }
                        
                        resolve();
                        
                        // Sauvegarde auto en arri√®re-plan
                        createAutoBackup().catch(error => {
                            console.error('Erreur sauvegarde auto apr√®s suppression:', error);
                        });
                        
                        if (document.getElementById('avancement').classList.contains('active')) {
                            loadVehicleProgress();
                        }
                    };
                    request.onerror = () => reject(request.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        // Vider toute la base de donn√©es
        function clearAllData() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.clear();
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // === FONCTIONS DE GESTION DES ALERTES ===

        // Sauvegarder une alerte
        function saveAlert(alertData) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([ALERT_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(ALERT_STORE_NAME);
                const request = store.add(alertData);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // R√©cup√©rer toutes les alertes
        function getAllAlerts() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([ALERT_STORE_NAME], 'readonly');
                const store = transaction.objectStore(ALERT_STORE_NAME);
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Mettre √† jour une alerte
        function updateAlert(alertData) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([ALERT_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(ALERT_STORE_NAME);
                const request = store.put(alertData);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Supprimer les alertes li√©es √† un contr√¥le
        function deleteAlertsByControlId(controlId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([ALERT_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(ALERT_STORE_NAME);
                const index = store.index('controlId');
                const request = index.openCursor(controlId);
                
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        cursor.delete();
                        cursor.continue();
                    } else {
                        resolve();
                    }
                };
                request.onerror = () => reject(request.error);
            });
        }

        // Vider toutes les alertes
        function clearAllAlerts() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([ALERT_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(ALERT_STORE_NAME);
                const request = store.clear();
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // D√©tecter les anomalies dans un contr√¥le
        function detectAnomalies(control) {
            const anomalies = {
                documents: [],
                equipments: [],
                conditions: []
            };

            // V√©rifier les documents obligatoires
            const documents = {
                'permis': 'Permis de conduire',
                'carteVerte': 'Carte verte (assurance)',
                'carteGrise': 'Carte grise',
                'carteCarburant': 'Carte carburant'
            };

            Object.entries(documents).forEach(([key, label]) => {
                if (!control[key]) {
                    anomalies.documents.push({
                        item: label,
                        status: 'missing',
                        severity: 'critical'
                    });
                }
            });

            // V√©rifier les √©quipements de s√©curit√©
            const equipments = {
                'giletJaune': 'Gilet jaune',
                'triangle': 'Triangle de signalisation',
                'roueSecours': 'Roue de secours',
                'trousseSecours': 'Trousse de secours'
            };

            Object.entries(equipments).forEach(([key, label]) => {
                if (!control[key]) {
                    anomalies.equipments.push({
                        item: label,
                        status: 'missing',
                        severity: 'warning'
                    });
                }
            });

            // V√©rifier l'√©tat g√©n√©ral et des pneus
            const conditions = {
                'etatRangement': 'Rangement du v√©hicule',
                'propret√©Interieur': 'Propret√© int√©rieur',
                'propret√©Exterieur': 'Propret√© ext√©rieur',
                'pneuAvantGauche': 'Pneu avant gauche',
                'pneuAvantDroit': 'Pneu avant droit',
                'pneuArriereGauche': 'Pneu arri√®re gauche',
                'pneuArriereDroit': 'Pneu arri√®re droit'
            };

            Object.entries(conditions).forEach(([key, label]) => {
                if (control[key] === 'mauvais') {
                    anomalies.conditions.push({
                        item: label,
                        status: 'bad',
                        severity: key.includes('pneu') ? 'critical' : 'warning'
                    });
                }
            });

            return anomalies;
        }

        // G√©n√©rer des alertes pour tous les contr√¥les
        async function generateAlertsFromControls() {
            try {
                const controls = await getAllControls();
                const existingAlerts = await getAllAlerts();
                
                // Cr√©er un map des alertes existantes par controlId
                const alertMap = new Map();
                existingAlerts.forEach(alert => {
                    alertMap.set(alert.controlId, alert);
                });

                for (const control of controls) {
                    const anomalies = detectAnomalies(control);
                    const totalIssues = anomalies.documents.length + anomalies.equipments.length + anomalies.conditions.length;
                    
                    const existingAlert = alertMap.get(control.id);
                    
                    if (totalIssues > 0) {
                        // D√©terminer la s√©v√©rit√© globale
                        const hasCritical = [...anomalies.documents, ...anomalies.equipments, ...anomalies.conditions]
                            .some(issue => issue.severity === 'critical');
                        const overallSeverity = hasCritical ? 'critical' : 'warning';
                        
                        // D√©terminer le type principal
                        let primaryType = 'condition';
                        if (anomalies.documents.length > 0) primaryType = 'document';
                        else if (anomalies.equipments.length > 0) primaryType = 'equipment';

                        const alertData = {
                            controlId: control.id,
                            immatriculation: control.immatriculation,
                            conducteur: control.conducteur,
                            dateControle: control.dateControle,
                            severity: overallSeverity,
                            type: primaryType,
                            status: existingAlert ? existingAlert.status : 'active',
                            issues: anomalies,
                            totalIssues: totalIssues,
                            dateCreated: existingAlert ? existingAlert.dateCreated : new Date().toISOString(),
                            dateUpdated: new Date().toISOString(),
                            resolvedBy: existingAlert ? existingAlert.resolvedBy : null,
                            resolvedDate: existingAlert ? existingAlert.resolvedDate : null,
                            notes: existingAlert ? existingAlert.notes : ''
                        };

                        if (existingAlert) {
                            alertData.id = existingAlert.id;
                            await updateAlert(alertData);
                        } else {
                            await saveAlert(alertData);
                        }
                    } else if (existingAlert && totalIssues === 0) {
                        // Supprimer l'alerte si plus d'anomalies
                        await deleteAlertsByControlId(control.id);
                    }
                }
                
            } catch (error) {
                console.error('Erreur lors de la g√©n√©ration des alertes:', error);
                throw error;
            }
        }

        // Charger et afficher les alertes
        async function loadAlerts() {
            try {
                await generateAlertsFromControls();
                const alerts = await getAllAlerts();
                currentAlerts = alerts;
                
                updateAlertStats(alerts);
                displayAlerts(alerts);
                
            } catch (error) {
                console.error('Erreur lors du chargement des alertes:', error);
                showMessage('error', 'Erreur lors du chargement des alertes : ' + error.message);
            }
        }

        // Mettre √† jour les statistiques des alertes
        function updateAlertStats(alerts) {
            const activeAlerts = alerts.filter(alert => alert.status === 'active');
            const resolvedAlerts = alerts.filter(alert => alert.status === 'resolved');
            const criticalAlerts = alerts.filter(alert => alert.severity === 'critical' && alert.status === 'active');

            document.getElementById('totalAlerts').textContent = activeAlerts.length;
            document.getElementById('resolvedAlerts').textContent = resolvedAlerts.length;
            document.getElementById('criticalAlerts').textContent = criticalAlerts.length;

            const statsContainer = document.getElementById('alertStats');
            if (alerts.length > 0) {
                statsContainer.style.display = 'grid';
            } else {
                statsContainer.style.display = 'none';
            }
        }

        // Afficher les alertes
        function displayAlerts(alerts) {
            const container = document.getElementById('alertsList');
            
            if (alerts.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <h3>Aucune alerte d√©tect√©e</h3>
                        <p>Parfait ! Tous les contr√¥les sont conformes.</p>
                    </div>
                `;
                return;
            }

            // Trier les alertes par s√©v√©rit√© puis par date
            alerts.sort((a, b) => {
                if (a.status !== b.status) {
                    return a.status === 'active' ? -1 : 1;
                }
                if (a.severity !== b.severity) {
                    return a.severity === 'critical' ? -1 : 1;
                }
                return new Date(b.dateControle) - new Date(a.dateControle);
            });

            container.innerHTML = alerts.map(alert => createAlertCard(alert)).join('');
            updateBulkActions();
        }

        // Cr√©er une carte d'alerte
        function createAlertCard(alert) {
            const formatDate = (dateStr) => {
                return new Date(dateStr).toLocaleDateString('fr-FR');
            };

            const severityText = {
                'critical': 'Critique',
                'warning': 'Attention',
                'resolved': 'R√©solue'
            };

            const typeText = {
                'document': 'Documents',
                'equipment': '√âquipements', 
                'condition': '√âtat'
            };

            const severityIcon = alert.severity === 'critical' ? 'üî¥' : 'üü°';
            const statusIcon = alert.status === 'resolved' ? '‚úÖ' : severityIcon;

            const issuesHtml = `
                ${alert.issues.documents.length > 0 ? `
                    <div class="alert-category">
                        <h5>üìã Documents manquants</h5>
                        ${alert.issues.documents.map(issue => `
                            <div class="alert-issue">
                                <span class="issue-name">${issue.item}</span>
                                <span class="issue-status missing">Absent</span>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                ${alert.issues.equipments.length > 0 ? `
                    <div class="alert-category">
                        <h5>üõ°Ô∏è √âquipements manquants</h5>
                        ${alert.issues.equipments.map(issue => `
                            <div class="alert-issue">
                                <span class="issue-name">${issue.item}</span>
                                <span class="issue-status missing">Absent</span>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                ${alert.issues.conditions.length > 0 ? `
                    <div class="alert-category">
                        <h5>üîß √âtats d√©grad√©s</h5>
                        ${alert.issues.conditions.map(issue => `
                            <div class="alert-issue">
                                <span class="issue-name">${issue.item}</span>
                                <span class="issue-status bad">Mauvais</span>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            `;

            const resolvedInfo = alert.status === 'resolved' ? `
                <div style="margin-top: 10px; padding: 10px; background: #d4edda; border-radius: 4px; font-size: 0.9rem;">
                    ‚úÖ R√©solue le ${formatDate(alert.resolvedDate)} ${alert.resolvedBy ? 'par ' + alert.resolvedBy : ''}
                    ${alert.notes ? `<br><em>${alert.notes}</em>` : ''}
                </div>
            ` : '';

            return `
                <div class="alert-item ${alert.status} ${alert.severity}" data-alert-id="${alert.id}" data-status="${alert.status}" data-type="${alert.type}">
                    <div class="alert-select">
                        <input type="checkbox" onchange="updateBulkActions()" data-alert-id="${alert.id}">
                    </div>
                    
                    <div class="alert-header">
                        <div class="alert-title">
                            <span>${statusIcon}</span>
                            <div>
                                <div class="alert-vehicle">${alert.immatriculation} - ${alert.conducteur}</div>
                                <div class="alert-date">Contr√¥le du ${formatDate(alert.dateControle)}</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <span class="alert-severity ${alert.status === 'resolved' ? 'resolved' : alert.severity}">
                                ${alert.status === 'resolved' ? 'R√©solue' : severityText[alert.severity]}
                            </span>
                            <span style="font-size: 0.8rem; color: #6c757d;">
                                ${alert.totalIssues} anomalie(s)
                            </span>
                        </div>
                    </div>

                    <div class="alert-content">
                        <div class="alert-issues">
                            ${issuesHtml}
                        </div>
                        ${resolvedInfo}
                    </div>

                    <div class="alert-actions">
                        ${alert.status === 'active' ? `
                            <button class="btn btn-success" onclick="resolveAlert(${alert.id})" style="padding: 8px 15px; font-size: 0.9rem;">
                                ‚úÖ R√©soudre
                            </button>
                        ` : `
                            <button class="btn btn-warning" onclick="unresolveAlert(${alert.id})" style="padding: 8px 15px; font-size: 0.9rem;">
                                üîÑ R√©activer
                            </button>
                        `}
                        <button class="btn btn-info" onclick="viewControlDetails(${alert.controlId})" style="padding: 8px 15px; font-size: 0.9rem;">
                            üëÅÔ∏è Voir contr√¥le
                        </button>
                        <button class="btn btn-secondary" onclick="addAlertNote(${alert.id})" style="padding: 8px 15px; font-size: 0.9rem;">
                            üìù Note
                        </button>
                    </div>
                </div>
            `;
        }

        // R√©soudre une alerte
        async function resolveAlert(alertId) {
            try {
                const alerts = await getAllAlerts();
                const alert = alerts.find(a => a.id === alertId);
                
                if (!alert) {
                    throw new Error('Alerte introuvable');
                }

                const resolvedBy = prompt('Votre nom (optionnel) :') || '';
                const notes = prompt('Notes sur la r√©solution (optionnel) :') || '';

                alert.status = 'resolved';
                alert.resolvedDate = new Date().toISOString();
                alert.resolvedBy = resolvedBy;
                alert.notes = notes;
                alert.dateUpdated = new Date().toISOString();

                await updateAlert(alert);
                await loadAlerts();
                showMessage('success', 'Alerte r√©solue avec succ√®s');

            } catch (error) {
                showMessage('error', 'Erreur lors de la r√©solution : ' + error.message);
            }
        }

        // R√©activer une alerte
        async function unresolveAlert(alertId) {
            if (!confirm('√ätes-vous s√ªr de vouloir r√©activer cette alerte ?')) {
                return;
            }

            try {
                const alerts = await getAllAlerts();
                const alert = alerts.find(a => a.id === alertId);
                
                if (!alert) {
                    throw new Error('Alerte introuvable');
                }

                alert.status = 'active';
                alert.resolvedDate = null;
                alert.resolvedBy = null;
                alert.dateUpdated = new Date().toISOString();

                await updateAlert(alert);
                await loadAlerts();
                showMessage('success', 'Alerte r√©activ√©e avec succ√®s');

            } catch (error) {
                showMessage('error', 'Erreur lors de la r√©activation : ' + error.message);
            }
        }

        // Ajouter une note √† une alerte
        async function addAlertNote(alertId) {
            try {
                const alerts = await getAllAlerts();
                const alert = alerts.find(a => a.id === alertId);
                
                if (!alert) {
                    throw new Error('Alerte introuvable');
                }

                const currentNote = alert.notes || '';
                const newNote = prompt('Note sur cette alerte :', currentNote);
                
                if (newNote !== null) {
                    alert.notes = newNote;
                    alert.dateUpdated = new Date().toISOString();
                    
                    await updateAlert(alert);
                    await loadAlerts();
                    showMessage('success', 'Note mise √† jour');
                }

            } catch (error) {
                showMessage('error', 'Erreur lors de la mise √† jour : ' + error.message);
            }
        }

        // Voir les d√©tails du contr√¥le
        function viewControlDetails(controlId) {
            showTab('historique');
            // Faire d√©filer vers l'√©l√©ment apr√®s un court d√©lai pour laisser le temps √† l'onglet de se charger
            setTimeout(() => {
                const controlElement = document.querySelector(`[onclick*="deleteControlById(${controlId})"]`);
                if (controlElement) {
                    const controlItem = controlElement.closest('.control-item');
                    if (controlItem) {
                        controlItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        controlItem.style.border = '3px solid #007bff';
                        controlItem.style.backgroundColor = '#f0f8ff';
                        
                        setTimeout(() => {
                            controlItem.style.border = '';
                            controlItem.style.backgroundColor = '';
                        }, 3000);
                    }
                }
            }, 500);
        }

        // Filtrer les alertes
        function filterAlerts() {
            const statusFilter = document.getElementById('alertStatusFilter').value;
            const typeFilter = document.getElementById('alertTypeFilter').value;
            const searchTerm = document.getElementById('alertSearchInput').value.toLowerCase();

            let filteredAlerts = [...currentAlerts];

            // Filtrer par statut
            if (statusFilter !== 'all') {
                filteredAlerts = filteredAlerts.filter(alert => alert.status === statusFilter);
            }

            // Filtrer par type
            if (typeFilter !== 'all') {
                filteredAlerts = filteredAlerts.filter(alert => alert.type === typeFilter);
            }

            // Filtrer par recherche textuelle
            if (searchTerm) {
                filteredAlerts = filteredAlerts.filter(alert => 
                    alert.immatriculation.toLowerCase().includes(searchTerm) ||
                    alert.conducteur.toLowerCase().includes(searchTerm)
                );
            }

            displayAlerts(filteredAlerts);
        }

        // Actualiser les alertes
        async function refreshAlerts() {
            try {
                showMessage('info', 'Actualisation des alertes en cours...');
                await loadAlerts();
                showMessage('success', 'Alertes actualis√©es avec succ√®s');
            } catch (error) {
                showMessage('error', 'Erreur lors de l\'actualisation : ' + error.message);
            }
        }

        // Mettre √† jour les actions group√©es
        function updateBulkActions() {
            const checkboxes = document.querySelectorAll('#alertsList input[type="checkbox"]');
            const checkedBoxes = document.querySelectorAll('#alertsList input[type="checkbox"]:checked');
            const bulkActions = document.getElementById('bulkActions');
            const selectedCount = document.getElementById('selectedCount');

            const count = checkedBoxes.length;
            selectedCount.textContent = `${count} alerte(s) s√©lectionn√©e(s)`;

            if (count > 0) {
                bulkActions.style.display = 'block';
            } else {
                bulkActions.style.display = 'none';
            }
        }

        // R√©soudre les alertes s√©lectionn√©es
        async function resolveSelectedAlerts() {
            const checkedBoxes = document.querySelectorAll('#alertsList input[type="checkbox"]:checked');
            const alertIds = Array.from(checkedBoxes).map(cb => parseInt(cb.getAttribute('data-alert-id')));

            if (alertIds.length === 0) {
                showMessage('warning', 'Aucune alerte s√©lectionn√©e');
                return;
            }

            if (!confirm(`√ätes-vous s√ªr de vouloir r√©soudre ${alertIds.length} alerte(s) ?`)) {
                return;
            }

            const resolvedBy = prompt('Votre nom (optionnel) :') || '';
            const notes = prompt('Notes sur la r√©solution (optionnel) :') || '';

            try {
                const alerts = await getAllAlerts();
                
                for (const alertId of alertIds) {
                    const alert = alerts.find(a => a.id === alertId);
                    if (alert && alert.status === 'active') {
                        alert.status = 'resolved';
                        alert.resolvedDate = new Date().toISOString();
                        alert.resolvedBy = resolvedBy;
                        alert.notes = notes;
                        alert.dateUpdated = new Date().toISOString();
                        await updateAlert(alert);
                    }
                }

                await loadAlerts();
                showMessage('success', `${alertIds.length} alerte(s) r√©solue(s) avec succ√®s`);

            } catch (error) {
                showMessage('error', 'Erreur lors de la r√©solution : ' + error.message);
            }
        }

        // R√©activer les alertes s√©lectionn√©es
        async function unresolveSelectedAlerts() {
            const checkedBoxes = document.querySelectorAll('#alertsList input[type="checkbox"]:checked');
            const alertIds = Array.from(checkedBoxes).map(cb => parseInt(cb.getAttribute('data-alert-id')));

            if (alertIds.length === 0) {
                showMessage('warning', 'Aucune alerte s√©lectionn√©e');
                return;
            }

            if (!confirm(`√ätes-vous s√ªr de vouloir r√©activer ${alertIds.length} alerte(s) ?`)) {
                return;
            }

            try {
                const alerts = await getAllAlerts();
                
                for (const alertId of alertIds) {
                    const alert = alerts.find(a => a.id === alertId);
                    if (alert && alert.status === 'resolved') {
                        alert.status = 'active';
                        alert.resolvedDate = null;
                        alert.resolvedBy = null;
                        alert.dateUpdated = new Date().toISOString();
                        await updateAlert(alert);
                    }
                }

                await loadAlerts();
                showMessage('success', `${alertIds.length} alerte(s) r√©activ√©e(s) avec succ√®s`);

            } catch (error) {
                showMessage('error', 'Erreur lors de la r√©activation : ' + error.message);
            }
        }

        // Exporter les alertes s√©lectionn√©es
        async function exportSelectedAlerts() {
            const checkedBoxes = document.querySelectorAll('#alertsList input[type="checkbox"]:checked');
            const alertIds = Array.from(checkedBoxes).map(cb => parseInt(cb.getAttribute('data-alert-id')));

            if (alertIds.length === 0) {
                showMessage('warning', 'Aucune alerte s√©lectionn√©e');
                return;
            }

            try {
                const alerts = await getAllAlerts();
                const selectedAlerts = alerts.filter(alert => alertIds.includes(alert.id));

                const excelData = selectedAlerts.map(alert => {
                    const issuesList = [
                        ...alert.issues.documents.map(issue => `DOC: ${issue.item} (${issue.status})`),
                        ...alert.issues.equipments.map(issue => `EQP: ${issue.item} (${issue.status})`),
                        ...alert.issues.conditions.map(issue => `ETAT: ${issue.item} (${issue.status})`)
                    ].join('; ');

                    return {
                        'Immatriculation': alert.immatriculation,
                        'Conducteur': alert.conducteur,
                        'Date contr√¥le': new Date(alert.dateControle).toLocaleDateString('fr-FR'),
                        'S√©v√©rit√©': alert.severity === 'critical' ? 'Critique' : 'Attention',
                        'Type': alert.type === 'document' ? 'Documents' : alert.type === 'equipment' ? '√âquipements' : '√âtat',
                        'Statut': alert.status === 'active' ? 'Active' : 'R√©solue',
                        'Nb anomalies': alert.totalIssues,
                        'D√©tail anomalies': issuesList,
                        'Date cr√©ation': new Date(alert.dateCreated).toLocaleDateString('fr-FR'),
                        'R√©solu par': alert.resolvedBy || '',
                        'Date r√©solution': alert.resolvedDate ? new Date(alert.resolvedDate).toLocaleDateString('fr-FR') : '',
                        'Notes': alert.notes || ''
                    };
                });

                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                const colWidths = [];
                Object.keys(excelData[0]).forEach(key => {
                    const maxLength = Math.max(
                        key.length,
                        ...excelData.map(row => String(row[key] || '').length)
                    );
                    colWidths.push({ width: Math.min(maxLength + 2, 50) });
                });
                ws['!cols'] = colWidths;
                
                XLSX.utils.book_append_sheet(wb, ws, 'Alertes S√©lectionn√©es');
                
                const fileName = `Alertes_Selection_GazService_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showMessage('success', `Fichier "${fileName}" t√©l√©charg√© avec succ√®s !`);

            } catch (error) {
                showMessage('error', 'Erreur lors de l\'export : ' + error.message);
            }
        }

        // === FONCTIONS DE GESTION DES V√âHICULES ===

        function saveVehicleList(vehicles) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([VEHICLE_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(VEHICLE_STORE_NAME);
                
                const clearRequest = store.clear();
                
                clearRequest.onsuccess = () => {
                    let processed = 0;
                    
                    vehicles.forEach(vehicle => {
                        const addRequest = store.add(vehicle);
                        addRequest.onsuccess = () => {
                            processed++;
                            if (processed === vehicles.length) {
                                resolve();
                                createAutoBackup().catch(console.error);
                            }
                        };
                        addRequest.onerror = () => reject(addRequest.error);
                    });
                    
                    if (vehicles.length === 0) {
                        resolve();
                    }
                };
                
                clearRequest.onerror = () => reject(clearRequest.error);
            });
        }

        function getVehicleList() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([VEHICLE_STORE_NAME], 'readonly');
                const store = transaction.objectStore(VEHICLE_STORE_NAME);
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function clearVehicleListFromDB() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([VEHICLE_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(VEHICLE_STORE_NAME);
                const request = store.clear();
                
                request.onsuccess = () => {
                    resolve();
                    createAutoBackup().catch(console.error);
                };
                request.onerror = () => reject(request.error);
            });
        }

        function handleVehicleListFile(input) {
            const importBtn = document.getElementById('importBtn');
            const statusEl = document.getElementById('progressStatus');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                    statusEl.innerHTML = '<div class="error-message">Veuillez s√©lectionner un fichier Excel (.xlsx ou .xls)</div>';
                    importBtn.disabled = true;
                    return;
                }
                
                selectedVehicleFile = file;
                importBtn.disabled = false;
                statusEl.innerHTML = `<div class="info-message">Fichier s√©lectionn√© : ${file.name}</div>`;
            } else {
                selectedVehicleFile = null;
                importBtn.disabled = true;
                statusEl.innerHTML = '';
            }
        }

        async function importVehicleList() {
            if (!selectedVehicleFile) return;
            
            const statusEl = document.getElementById('progressStatus');
            
            try {
                statusEl.innerHTML = '<div class="info-message">Lecture du fichier Excel...</div>';
                
                const arrayBuffer = await readFileAsArrayBuffer(selectedVehicleFile);
                const workbook = XLSX.read(arrayBuffer);
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                if (jsonData.length < 2) {
                    throw new Error('Le fichier doit contenir au moins une ligne de donn√©es');
                }
                
                const vehicles = [];
                const startRow = 0;
                
                for (let i = startRow; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    
                    if (row[0] && row[0].toString().trim()) {
                        const immatriculation = row[0].toString().trim().toUpperCase();
                        const marque = row[1] ? row[1].toString().trim() : '';
                        const modele = row[2] ? row[2].toString().trim() : '';
                        
                        if (immatriculation.length > 0) {
                            vehicles.push({
                                immatriculation: immatriculation,
                                marque: marque,
                                modele: modele,
                                dateImport: new Date().toISOString()
                            });
                        }
                    }
                }
                
                if (vehicles.length === 0) {
                    throw new Error('Aucun v√©hicule valide trouv√© dans le fichier');
                }
                
                await saveVehicleList(vehicles);
                await loadVehicleProgress();
                
                statusEl.innerHTML = `<div class="success-message">‚úÖ ${vehicles.length} v√©hicule(s) import√©(s) avec succ√®s !</div>`;
                
                document.getElementById('vehicleListFile').value = '';
                document.getElementById('importBtn').disabled = true;
                selectedVehicleFile = null;
                
            } catch (error) {
                statusEl.innerHTML = `<div class="error-message">‚ùå Erreur lors de l'importation : ${error.message}</div>`;
            }
        }

        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(new Error('Erreur de lecture du fichier'));
                reader.readAsArrayBuffer(file);
            });
        }

        // Charger et afficher le suivi d'avancement avec r√®gle des 35 jours
        async function loadVehicleProgress() {
            try {
                const vehicles = await getVehicleList();
                const controls = await getAllControls();
                
                if (vehicles.length === 0) {
                    document.getElementById('progressStats').style.display = 'none';
                    document.getElementById('vehicleListContainer').style.display = 'none';
                    return;
                }
                
                const totalVehicles = vehicles.length;
                let controlledCount = 0;
                let expiredCount = 0;
                
                // Cr√©er un map des contr√¥les par immatriculation (prendre le plus r√©cent)
                const controlMap = new Map();
                controls.forEach(control => {
                    const immat = control.immatriculation;
                    if (!controlMap.has(immat) || new Date(control.dateControle) > new Date(controlMap.get(immat).dateControle)) {
                        controlMap.set(immat, control);
                    }
                });
                
                // V√©rifier chaque v√©hicule avec la r√®gle des 35 jours
                const vehicleProgress = vehicles.map(vehicle => {
                    const control = controlMap.get(vehicle.immatriculation);
                    
                    if (!control) {
                        return {
                            ...vehicle,
                            status: 'pending',
                            isControlled: false,
                            lastControl: null,
                            daysSinceControl: Infinity
                        };
                    }
                    
                    const daysSince = daysDifference(control.dateControle);
                    const isValid = isControlValid(control.dateControle);
                    
                    if (isValid) {
                        controlledCount++;
                        return {
                            ...vehicle,
                            status: 'controlled',
                            isControlled: true,
                            lastControl: control,
                            daysSinceControl: daysSince
                        };
                    } else {
                        expiredCount++;
                        return {
                            ...vehicle,
                            status: 'expired',
                            isControlled: false,
                            lastControl: control,
                            daysSinceControl: daysSince
                        };
                    }
                });
                
                const pendingCount = totalVehicles - controlledCount - expiredCount;
                const completionPercent = totalVehicles > 0 ? Math.round((controlledCount / totalVehicles) * 100) : 0;
                
                // Mettre √† jour les statistiques
                document.getElementById('totalVehicles').textContent = totalVehicles;
                document.getElementById('controlledVehicles').textContent = controlledCount;
                document.getElementById('expiredVehicles').textContent = expiredCount;
                document.getElementById('pendingVehicles').textContent = pendingCount;
                document.getElementById('completionPercent').textContent = completionPercent + '%';
                document.getElementById('progressFill').style.width = completionPercent + '%';
                
                document.getElementById('progressStats').style.display = 'grid';
                document.getElementById('vehicleListContainer').style.display = 'block';
                
                displayVehicleList(vehicleProgress);
                vehicleList = vehicleProgress;
                
            } catch (error) {
                console.error('Erreur lors du chargement du suivi d\'avancement:', error);
            }
        }

        function displayVehicleList(vehicles) {
            const container = document.getElementById('vehicleList');
            
            if (vehicles.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <h3>Aucun v√©hicule dans la liste</h3>
                        <p>Importez un fichier Excel pour commencer le suivi</p>
                    </div>
                `;
                return;
            }
            
            vehicles.sort((a, b) => {
                const statusOrder = { 'pending': 1, 'expired': 2, 'controlled': 3 };
                if (statusOrder[a.status] !== statusOrder[b.status]) {
                    return statusOrder[a.status] - statusOrder[b.status];
                }
                return a.immatriculation.localeCompare(b.immatriculation);
            });
            
            container.innerHTML = vehicles.map(vehicle => {
                let statusClass, statusIcon, statusText, lastControlText;
                
                switch (vehicle.status) {
                    case 'controlled':
                        statusClass = 'checked';
                        statusIcon = '‚úì';
                        statusText = `Contr√¥l√© (${vehicle.daysSinceControl}j)`;
                        lastControlText = new Date(vehicle.lastControl.dateControle).toLocaleDateString('fr-FR');
                        break;
                    case 'expired':
                        statusClass = 'expired';
                        statusIcon = '‚ö†';
                        statusText = `Expir√© (${vehicle.daysSinceControl}j)`;
                        lastControlText = new Date(vehicle.lastControl.dateControle).toLocaleDateString('fr-FR');
                        break;
                    default:
                        statusClass = 'pending';
                        statusIcon = '!';
                        statusText = 'En attente';
                        lastControlText = 'Aucun contr√¥le';
                }
                
                return `
                    <div class="vehicle-item ${statusClass}">
                        <div class="vehicle-info">
                            <div class="vehicle-immat">${vehicle.immatriculation}</div>
                            <div class="vehicle-details">
                                ${vehicle.marque} ${vehicle.modele}
                                ${vehicle.lastControl ? ` - Conducteur: ${vehicle.lastControl.conducteur}` : ''}
                            </div>
                            <div class="last-control-date">Dernier contr√¥le: ${lastControlText}</div>
                        </div>
                        <div class="vehicle-status">
                            <div class="status-icon ${vehicle.status === 'controlled' ? 'done' : vehicle.status === 'expired' ? 'expired' : 'pending'}">${statusIcon}</div>
                            <span>${statusText}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterVehicleList() {
            const searchTerm = document.getElementById('vehicleSearchInput').value.toLowerCase();
            const vehicleItems = document.querySelectorAll('.vehicle-item');
            
            vehicleItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });
        }

        async function clearVehicleList() {
            if (confirm('√ätes-vous s√ªr de vouloir vider la liste des v√©hicules ?')) {
                try {
                    await clearVehicleListFromDB();
                    await loadVehicleProgress();
                    showMessage('success', '‚úÖ Liste des v√©hicules vid√©e avec succ√®s');
                } catch (error) {
                    showMessage('error', '‚ùå Erreur lors de la suppression : ' + error.message);
                }
            }
        }

        async function exportProgressToExcel() {
            try {
                const vehicles = await getVehicleList();
                const controls = await getAllControls();
                
                if (vehicles.length === 0) {
                    showMessage('warning', 'Aucune donn√©e √† exporter');
                    return;
                }
                
                const controlMap = new Map();
                controls.forEach(control => {
                    const immat = control.immatriculation;
                    if (!controlMap.has(immat) || new Date(control.dateControle) > new Date(controlMap.get(immat).dateControle)) {
                        controlMap.set(immat, control);
                    }
                });
                
                const excelData = vehicles.map(vehicle => {
                    const control = controlMap.get(vehicle.immatriculation);
                    let status = 'En attente';
                    let daysSince = '';
                    
                    if (control) {
                        const days = daysDifference(control.dateControle);
                        daysSince = days;
                        status = isControlValid(control.dateControle) ? 
                            `Contr√¥l√© (${days}j)` : `Expir√© (${days}j)`;
                    }
                    
                    return {
                        'Immatriculation': vehicle.immatriculation,
                        'Marque': vehicle.marque,
                        'Mod√®le': vehicle.modele,
                        'Statut': status,
                        'Jours depuis contr√¥le': daysSince,
                        'Date dernier contr√¥le': control ? control.dateControle : '',
                        'Conducteur': control ? control.conducteur : '',
                        'Kilom√©trage': control ? control.kilometrage || '' : '',
                        'Prochain CT': control ? control.prochainControle || '' : '',
                        'Derni√®re r√©vision (km)': control ? control.derniereRevision || '' : '',
                        'Date import v√©hicule': new Date(vehicle.dateImport).toLocaleDateString('fr-FR')
                    };
                });
                
                const totalVehicles = vehicles.length;
                const controlledCount = excelData.filter(v => v.Statut.includes('Contr√¥l√©')).length;
                const expiredCount = excelData.filter(v => v.Statut.includes('Expir√©')).length;
                const pendingCount = totalVehicles - controlledCount - expiredCount;
                const completionPercent = totalVehicles > 0 ? Math.round((controlledCount / totalVehicles) * 100) : 0;
                
                const summaryData = [
                    ['Statistique', 'Valeur'],
                    ['Total v√©hicules', totalVehicles],
                    ['V√©hicules contr√¥l√©s (< 35j)', controlledCount],
                    ['V√©hicules contr√¥les expir√©s (> 35j)', expiredCount],
                    ['V√©hicules en attente', pendingCount],
                    ['Pourcentage d\'avancement', completionPercent + '%'],
                    ['R√®gle d\'expiration', CONTROL_EXPIRY_DAYS + ' jours'],
                    ['Date d\'export', new Date().toLocaleDateString('fr-FR')]
                ];
                
                const wb = XLSX.utils.book_new();
                
                const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, wsSummary, 'R√©sum√©');
                
                const wsDetail = XLSX.utils.json_to_sheet(excelData);
                
                const colWidths = [];
                Object.keys(excelData[0]).forEach(key => {
                    const maxLength = Math.max(
                        key.length,
                        ...excelData.map(row => String(row[key] || '').length)
                    );
                    colWidths.push({ width: Math.min(maxLength + 2, 50) });
                });
                wsDetail['!cols'] = colWidths;
                
                XLSX.utils.book_append_sheet(wb, wsDetail, 'D√©tail v√©hicules');
                
                const fileName = `Suivi_Avancement_GazService_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showMessage('success', `‚úÖ Fichier "${fileName}" t√©l√©charg√© avec succ√®s !`);
                
            } catch (error) {
                showMessage('error', '‚ùå Erreur lors de l\'export : ' + error.message);
            }
        }

        // === FONCTIONS DE GESTION DES PHOTOS ===

        async function openCamera() {
            if (currentPhotos.length >= MAX_PHOTOS) {
                showMessage('warning', `Vous avez d√©j√† atteint la limite de ${MAX_PHOTOS} photos par contr√¥le`);
                return;
            }

            try {
                const modal = document.getElementById('cameraModal');
                const video = document.getElementById('cameraVideo');
                
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'environment'
                    } 
                });
                
                video.srcObject = cameraStream;
                modal.style.display = 'flex';
                
            } catch (error) {
                console.error('Erreur d\'acc√®s √† la cam√©ra:', error);
                showMessage('error', 'Impossible d\'acc√©der √† la cam√©ra. V√©rifiez les permissions de votre navigateur.');
            }
        }

        function closeCamera() {
            const modal = document.getElementById('cameraModal');
            const video = document.getElementById('cameraVideo');
            
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            video.srcObject = null;
            modal.style.display = 'none';
        }

        function takePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('photoCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            ctx.drawImage(video, 0, 0);
            
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            
            const photoObj = {
                id: Date.now() + Math.random(),
                data: imageData,
                timestamp: new Date().toISOString()
            };
            
            currentPhotos.push(photoObj);
            updatePhotoPreview();
            closeCamera();
            
            showMessage('success', `Photo ${currentPhotos.length}/${MAX_PHOTOS} ajout√©e avec succ√®s`);
        }

        function updatePhotoPreview() {
            const preview = document.getElementById('photoPreview');
            const counter = document.getElementById('photoCount');
            const cameraBtn = document.getElementById('cameraBtn');
            
            counter.textContent = `${currentPhotos.length}/${MAX_PHOTOS} photos`;
            
            if (currentPhotos.length >= MAX_PHOTOS) {
                cameraBtn.disabled = true;
                cameraBtn.textContent = 'üì± Limite atteinte (5/5)';
                cameraBtn.style.opacity = '0.6';
            } else {
                cameraBtn.disabled = false;
                cameraBtn.textContent = 'üì± Prendre une photo';
                cameraBtn.style.opacity = '1';
            }
            
            preview.innerHTML = currentPhotos.map((photo, index) => `
                <div class="photo-item">
                    <img src="${photo.data}" alt="Photo ${index + 1}" onclick="viewPhoto('${photo.data}')">
                    <button class="photo-delete" onclick="deletePhoto('${photo.id}')" title="Supprimer cette photo">√ó</button>
                </div>
            `).join('');
        }

        function deletePhoto(photoId) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette photo ?')) {
                currentPhotos = currentPhotos.filter(photo => photo.id !== photoId);
                updatePhotoPreview();
                showMessage('success', 'Photo supprim√©e');
            }
        }

        function viewPhoto(imageData) {
            const modal = document.createElement('div');
            modal.className = 'photo-viewer-modal';
            modal.innerHTML = `
                <div class="photo-viewer-content">
                    <button class="photo-viewer-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
                    <img src="${imageData}" alt="Photo agrandie" class="photo-viewer-image">
                </div>
            `;
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            document.body.appendChild(modal);
        }

        function resetPhotos() {
            currentPhotos = [];
            updatePhotoPreview();
        }

        // === FONCTIONS PDF ===

        async function filterControlsForPDF() {
            const dateDebut = document.getElementById('pdfDateDebut').value;
            const dateFin = document.getElementById('pdfDateFin').value;
            const resultsDiv = document.getElementById('pdfResults');
            const listDiv = document.getElementById('pdfControlsList');
            const statusDiv = document.getElementById('pdfStatus');

            try {
                statusDiv.innerHTML = '<div class="info-message">Recherche des contr√¥les...</div>';
                
                const allControls = await getAllControls();
                
                let filtered = allControls;
                
                if (dateDebut) {
                    filtered = filtered.filter(control => control.dateControle >= dateDebut);
                }
                
                if (dateFin) {
                    filtered = filtered.filter(control => control.dateControle <= dateFin);
                }
                
                filtered.sort((a, b) => new Date(b.dateControle) - new Date(a.dateControle));
                
                filteredControlsForPDF = filtered;
                
                if (filtered.length === 0) {
                    statusDiv.innerHTML = '<div class="warning-message">Aucun contr√¥le trouv√© pour cette p√©riode</div>';
                    resultsDiv.style.display = 'none';
                    return;
                }
                
                listDiv.innerHTML = filtered.map(control => `
                    <div class="pdf-control-item">
                        <div class="pdf-control-info">
                            <strong>${control.immatriculation} - ${control.conducteur}</strong><br>
                            <small>Date: ${new Date(control.dateControle).toLocaleDateString('fr-FR')}</small>
                            ${control.photos && control.photos.length > 0 ? ` - ${control.photos.length} photo(s)` : ''}
                        </div>
                        <div class="pdf-control-actions">
                            <button class="btn btn-info" onclick="generateSinglePDF(${control.id})" style="padding: 8px 15px; font-size: 0.9rem;">
                                üìÑ G√©n√©rer PDF
                            </button>
                        </div>
                    </div>
                `).join('');
                
                resultsDiv.style.display = 'block';
                statusDiv.innerHTML = `<div class="success-message">${filtered.length} contr√¥le(s) trouv√©(s)</div>`;
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="error-message">Erreur lors de la recherche: ${error.message}</div>`;
            }
        }

        async function generateSinglePDF(controlId) {
            const loadingEl = document.getElementById('pdfLoading');
            const statusEl = document.getElementById('pdfStatus');
            
            try {
                loadingEl.style.display = 'block';
                statusEl.innerHTML = '';
                
                // R√©cup√©rer le contr√¥le sp√©cifique
                const controls = await getAllControls();
                const control = controls.find(c => c.id === controlId);
                
                if (!control) {
                    throw new Error('Contr√¥le introuvable');
                }
                
                // Initialiser jsPDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Configuration des couleurs et styles
                const primaryColor = [52, 58, 64];
                const secondaryColor = [108, 117, 125];
                const successColor = [40, 167, 69];
                const dangerColor = [220, 53, 69];
                const warningColor = [255, 193, 7];
                
                let yPosition = 20;
                const pageWidth = doc.internal.pageSize.width;
                const margin = 20;
                const contentWidth = pageWidth - 2 * margin;
                
                // En-t√™te du document
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(20);
                doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                doc.text('RAPPORT DE CONTR√îLE V√âHICULE', margin, yPosition);
                
                yPosition += 15;
                doc.setFontSize(14);
                doc.setTextColor(secondaryColor[0], secondaryColor[1], secondaryColor[2]);
                doc.text('Gaz Service - Contr√¥le et maintenance', margin, yPosition);
                
                // Ligne de s√©paration
                yPosition += 10;
                doc.setDrawColor(108, 117, 125);
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 15;
                
                // Informations g√©n√©rales
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(16);
                doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                doc.text('INFORMATIONS G√âN√âRALES', margin, yPosition);
                yPosition += 10;
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(12);
                
                const formatDate = (dateStr) => {
                    if (!dateStr) return 'Non renseign√©';
                    return new Date(dateStr).toLocaleDateString('fr-FR');
                };
                
                const generalInfo = [
                    ['Immatriculation:', control.immatriculation || 'Non renseign√©'],
                    ['Conducteur:', control.conducteur || 'Non renseign√©'],
                    ['Date du contr√¥le:', formatDate(control.dateControle)],
                    ['Kilom√©trage:', control.kilometrage ? `${control.kilometrage} km` : 'Non renseign√©'],
                    ['Prochain CT:', formatDate(control.prochainControle)],
                    ['Derni√®re r√©vision:', control.derniereRevision ? `${control.derniereRevision} km` : 'Non renseign√©']
                ];
                
                generalInfo.forEach(([label, value]) => {
                    doc.setTextColor(secondaryColor[0], secondaryColor[1], secondaryColor[2]);
                    doc.text(label, margin, yPosition);
                    doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                    doc.text(value, margin + 50, yPosition);
                    yPosition += 8;
                });
                
                yPosition += 10;
                
                // Documents obligatoires
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(16);
                doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                doc.text('DOCUMENTS OBLIGATOIRES', margin, yPosition);
                yPosition += 10;
                
                const documents = [
                    ['Permis de conduire:', control.permis],
                    ['Carte verte (assurance):', control.carteVerte],
                    ['Carte grise:', control.carteGrise],
                    ['Carte carburant:', control.carteCarburant]
                ];
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(12);
                
                documents.forEach(([label, present]) => {
                    doc.setTextColor(secondaryColor[0], secondaryColor[1], secondaryColor[2]);
                    doc.text(label, margin, yPosition);
                    if (present) {
                        doc.setTextColor(successColor[0], successColor[1], successColor[2]);
                        doc.text('‚úì Pr√©sent', margin + 70, yPosition);
                    } else {
                        doc.setTextColor(dangerColor[0], dangerColor[1], dangerColor[2]);
                        doc.text('‚úó Absent', margin + 70, yPosition);
                    }
                    yPosition += 8;
                });
                
                yPosition += 10;
                
                // √âquipements de s√©curit√©
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(16);
                doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                doc.text('√âQUIPEMENTS DE S√âCURIT√â', margin, yPosition);
                yPosition += 10;
                
                const equipments = [
                    ['Gilet jaune:', control.giletJaune],
                    ['Triangle de signalisation:', control.triangle],
                    ['Roue de secours:', control.roueSecours],
                    ['Trousse de secours:', control.trousseSecours]
                ];
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(12);
                
                equipments.forEach(([label, present]) => {
                    doc.setTextColor(secondaryColor[0], secondaryColor[1], secondaryColor[2]);
                    doc.text(label, margin, yPosition);
                    if (present) {
                        doc.setTextColor(successColor[0], successColor[1], successColor[2]);
                        doc.text('‚úì Pr√©sent', margin + 70, yPosition);
                    } else {
                        doc.setTextColor(dangerColor[0], dangerColor[1], dangerColor[2]);
                        doc.text('‚úó Absent', margin + 70, yPosition);
                    }
                    yPosition += 8;
                });
                
                yPosition += 10;
                
                // V√©rifier si on a besoin d'une nouvelle page
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                // √âtat g√©n√©ral
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(16);
                doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                doc.text('√âTAT G√âN√âRAL', margin, yPosition);
                yPosition += 10;
                
                const states = [
                    ['Rangement du v√©hicule:', control.etatRangement],
                    ['Propret√© int√©rieur:', control.propret√©Interieur],
                    ['Propret√© ext√©rieur:', control.propret√©Exterieur]
                ];
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(12);
                
                states.forEach(([label, state]) => {
                    doc.setTextColor(secondaryColor[0], secondaryColor[1], secondaryColor[2]);
                    doc.text(label, margin, yPosition);
                    
                    switch(state) {
                        case 'bon': 
                            doc.setTextColor(successColor[0], successColor[1], successColor[2]);
                            break;
                        case 'moyen': 
                            doc.setTextColor(warningColor[0], warningColor[1], warningColor[2]);
                            break;
                        case 'mauvais': 
                            doc.setTextColor(dangerColor[0], dangerColor[1], dangerColor[2]);
                            break;
                        default: 
                            doc.setTextColor(secondaryColor[0], secondaryColor[1], secondaryColor[2]);
                    }
                    
                    doc.text(state ? state.charAt(0).toUpperCase() + state.slice(1) : 'Non renseign√©', margin + 60, yPosition);
                    yPosition += 8;
                });
                
                yPosition += 10;
                
                // √âtat des pneus
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(16);
                doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                doc.text('√âTAT DES PNEUS', margin, yPosition);
                yPosition += 10;
                
                const tires = [
                    ['Pneu avant gauche:', control.pneuAvantGauche],
                    ['Pneu avant droit:', control.pneuAvantDroit],
                    ['Pneu arri√®re gauche:', control.pneuArriereGauche],
                    ['Pneu arri√®re droit:', control.pneuArriereDroit]
                ];
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(12);
                
                tires.forEach(([label, state]) => {
                    doc.setTextColor(secondaryColor[0], secondaryColor[1], secondaryColor[2]);
                    doc.text(label, margin, yPosition);
                    
                    switch(state) {
                        case 'bon': 
                            doc.setTextColor(successColor[0], successColor[1], successColor[2]);
                            break;
                        case 'moyen': 
                            doc.setTextColor(warningColor[0], warningColor[1], warningColor[2]);
                            break;
                        case 'mauvais': 
                            doc.setTextColor(dangerColor[0], dangerColor[1], dangerColor[2]);
                            break;
                        default: 
                            doc.setTextColor(secondaryColor[0], secondaryColor[1], secondaryColor[2]);
                    }
                    
                    doc.text(state ? state.charAt(0).toUpperCase() + state.slice(1) : 'Non renseign√©', margin + 60, yPosition);
                    yPosition += 8;
                });
                
                yPosition += 10;
                
                // Commentaires
                if (control.commentaires && control.commentaires.trim()) {
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(16);
                    doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                    doc.text('COMMENTAIRES ET OBSERVATIONS', margin, yPosition);
                    yPosition += 10;
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(11);
                    doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                    
                    // Diviser le texte en lignes
                    const lines = doc.splitTextToSize(control.commentaires, contentWidth);
                    lines.forEach(line => {
                        if (yPosition > 280) {
                            doc.addPage();
                            yPosition = 20;
                        }
                        doc.text(line, margin, yPosition);
                        yPosition += 6;
                    });
                    
                    yPosition += 10;
                }
                
                // Photos
                if (control.photos && control.photos.length > 0) {
                    if (yPosition > 200) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(16);
                    doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                    doc.text(`PHOTOS DU CONTR√îLE (${control.photos.length})`, margin, yPosition);
                    yPosition += 15;
                    
                    // Ajouter les photos (max 4 par page)
                    let photosPerRow = 2;
                    let photoWidth = (contentWidth - 10) / photosPerRow;
                    let photoHeight = photoWidth * 0.75; // Ratio 4:3
                    
                    for (let i = 0; i < control.photos.length; i++) {
                        const photo = control.photos[i];
                        const row = Math.floor(i / photosPerRow);
                        const col = i % photosPerRow;
                        
                        const x = margin + col * (photoWidth + 5);
                        const y = yPosition + row * (photoHeight + 10);
                        
                        // V√©rifier si on a besoin d'une nouvelle page
                        if (y + photoHeight > 280) {
                            doc.addPage();
                            yPosition = 20;
                            const newRow = Math.floor((i % 4) / photosPerRow);
                            const newY = yPosition + newRow * (photoHeight + 10);
                            
                            try {
                                doc.addImage(photo.data, 'JPEG', x, newY, photoWidth, photoHeight);
                            } catch (error) {
                                console.warn('Erreur lors de l\'ajout de la photo:', error);
                                doc.setFontSize(10);
                                doc.setTextColor(secondaryColor[0], secondaryColor[1], secondaryColor[2]);
                                doc.text(`Photo ${i + 1} (erreur)`, x, newY + 10);
                            }
                        } else {
                            try {
                                doc.addImage(photo.data, 'JPEG', x, y, photoWidth, photoHeight);
                            } catch (error) {
                                console.warn('Erreur lors de l\'ajout de la photo:', error);
                                doc.setFontSize(10);
                                doc.setTextColor(secondaryColor[0], secondaryColor[1], secondaryColor[2]);
                                doc.text(`Photo ${i + 1} (erreur)`, x, y + 10);
                            }
                        }
                        
                        // Ajouter une nouvelle page tous les 4 photos
                        if ((i + 1) % 4 === 0 && i < control.photos.length - 1) {
                            doc.addPage();
                            yPosition = 20;
                        }
                    }
                }
                
                // Pied de page sur toutes les pages
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    doc.setTextColor(secondaryColor[0], secondaryColor[1], secondaryColor[2]);
                    doc.text(`Page ${i}/${pageCount}`, pageWidth - margin - 20, doc.internal.pageSize.height - 10);
                    doc.text(`G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR')}`, margin, doc.internal.pageSize.height - 10);
                }
                
                // Sauvegarder le PDF
                const fileName = `Controle_${control.immatriculation}_${control.dateControle}_${control.conducteur.replace(/\s+/g, '_')}.pdf`;
                doc.save(fileName);
                
                statusEl.innerHTML = `<div class="success-message">‚úÖ PDF "${fileName}" g√©n√©r√© et t√©l√©charg√© avec succ√®s !</div>`;
                
            } catch (error) {
                console.error('Erreur lors de la g√©n√©ration du PDF:', error);
                statusEl.innerHTML = `<div class="error-message">‚ùå Erreur lors de la g√©n√©ration du PDF : ${error.message}</div>`;
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        // Fonction utilitaire pour t√©l√©charger JSON
        function downloadJSON(data, filename) {
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function handleBackupFile(input) {
            const restoreBtn = document.getElementById('restoreBtn');
            const statusEl = document.getElementById('restoreStatus');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
                    statusEl.innerHTML = '<div class="error-message">Veuillez s√©lectionner un fichier JSON valide</div>';
                    restoreBtn.disabled = true;
                    return;
                }
                
                selectedBackupFile = file;
                restoreBtn.disabled = false;
                statusEl.innerHTML = `<div class="info-message">Fichier s√©lectionn√© : ${file.name}</div>`;
            } else {
                selectedBackupFile = null;
                restoreBtn.disabled = true;
                statusEl.innerHTML = '';
            }
        }

        async function restoreBackup() {
            if (!selectedBackupFile) return;
            
            const statusEl = document.getElementById('restoreStatus');
            
            if (!confirm('‚ö†Ô∏è ATTENTION ‚ö†Ô∏è\n\nCette action va SUPPRIMER toutes les donn√©es actuelles et les remplacer par celles du fichier de sauvegarde.\n\n√ätes-vous s√ªr de vouloir continuer ?')) {
                return;
            }
            
            try {
                statusEl.innerHTML = '<div class="info-message">Restauration en cours...</div>';
                
                const fileContent = await readFileAsText(selectedBackupFile);
                const backupData = JSON.parse(fileContent);
                
                if (backupData.version === '3.0' && backupData.data) {
                    const controls = backupData.data.controls || [];
                    const vehicles = backupData.data.vehicles || [];
                    const alerts = backupData.data.alerts || [];
                    
                    // Effacer toutes les donn√©es existantes
                    await clearAllData();
                    await clearVehicleListFromDB();
                    await clearAllAlerts();
                    
                    // Restaurer les contr√¥les
                    for (const control of controls) {
                        const { id, ...controlData } = control;
                        await saveControlDirectly(controlData);
                    }
                    
                    // Restaurer les v√©hicules
                    if (vehicles.length > 0) {
                        await saveVehicleList(vehicles);
                    }
                    
                    // Restaurer les alertes
                    for (const alert of alerts) {
                        const { id, ...alertData } = alert;
                        await saveAlert(alertData);
                    }
                    
                    statusEl.innerHTML = `<div class="success-message">
                        ‚úÖ Restauration r√©ussie !<br>
                        ${controls.length} contr√¥le(s) restaur√©(s)<br>
                        ${vehicles.length} v√©hicule(s) restaur√©(s)<br>
                        ${alerts.length} alerte(s) restaur√©e(s)<br>
                        Date de la sauvegarde : ${new Date(backupData.timestamp).toLocaleString('fr-FR')}
                    </div>`;
                    
                } else if ((backupData.version === '2.0' || backupData.version === '1.0') && backupData.data) {
                    // Compatibilit√© avec les anciennes versions
                    const controls = backupData.data.controls || backupData.data || [];
                    const vehicles = backupData.data.vehicles || [];
                    
                    await clearAllData();
                    await clearVehicleListFromDB();
                    await clearAllAlerts();
                    
                    for (const control of controls) {
                        const { id, ...controlData } = control;
                        await saveControlDirectly(controlData);
                    }
                    
                    if (vehicles.length > 0) {
                        await saveVehicleList(vehicles);
                    }
                    
                    // R√©g√©n√©rer les alertes pour les anciennes sauvegardes
                    await generateAlertsFromControls();
                    
                    statusEl.innerHTML = `<div class="success-message">
                        ‚úÖ Restauration r√©ussie !<br>
                        ${controls.length} contr√¥le(s) restaur√©(s)<br>
                        ${vehicles.length} v√©hicule(s) restaur√©(s)<br>
                        Alertes g√©n√©r√©es automatiquement<br>
                        Date de la sauvegarde : ${new Date(backupData.timestamp).toLocaleString('fr-FR')}
                    </div>`;
                } else {
                    throw new Error('Format de fichier de sauvegarde invalide');
                }
                
                await loadControls();
                await loadVehicleProgress();
                await loadAlerts();
                
                document.getElementById('backupFile').value = '';
                document.getElementById('restoreBtn').disabled = true;
                selectedBackupFile = null;
                
                createAutoBackup().catch(console.error);
                
            } catch (error) {
                statusEl.innerHTML = '<div class="error-message">Erreur lors de la restauration : ' + error.message + '</div>';
            }
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(new Error('Erreur de lecture du fichier'));
                reader.readAsText(file);
            });
        }

        function saveControlDirectly(data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.add(data);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // === FONCTIONS PRINCIPALES ===

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'historique') {
                loadControls();
            } else if (tabName === 'alertes') {
                loadAlerts();
            } else if (tabName === 'avancement') {
                loadVehicleProgress();
            } else if (tabName === 'pdf') {
                const today = new Date().toISOString().split('T')[0];
                const lastMonth = new Date();
                lastMonth.setMonth(lastMonth.getMonth() - 1);
                const lastMonthStr = lastMonth.toISOString().split('T')[0];
                
                if (!document.getElementById('pdfDateDebut').value) {
                    document.getElementById('pdfDateDebut').value = lastMonthStr;
                }
                if (!document.getElementById('pdfDateFin').value) {
                    document.getElementById('pdfDateFin').value = today;
                }
            }
        }

        document.getElementById('vehicleForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {
                conducteur: formData.get('conducteur'),
                dateControle: formData.get('dateControle'),
                immatriculation: formData.get('immatriculation').toUpperCase(),
                kilometrage: formData.get('kilometrage') || null,
                prochainControle: formData.get('prochainControle') || null,
                derniereRevision: formData.get('derniereRevision') || null,
                
                // Documents
                permis: formData.has('permis'),
                carteVerte: formData.has('carteVerte'),
                carteGrise: formData.has('carteGrise'),
                carteCarburant: formData.has('carteCarburant'),
                
                // √âquipements
                giletJaune: formData.has('giletJaune'),
                triangle: formData.has('triangle'),
                roueSecours: formData.has('roueSecours'),
                trousseSecours: formData.has('trousseSecours'),
                
                // √âtats
                etatRangement: formData.get('etatRangement'),
                propret√©Interieur: formData.get('propret√©Interieur'),
                propret√©Exterieur: formData.get('propret√©Exterieur'),
                
                // Pneus
                pneuAvantGauche: formData.get('pneuAvantGauche'),
                pneuAvantDroit: formData.get('pneuAvantDroit'),
                pneuArriereGauche: formData.get('pneuArriereGauche'),
                pneuArriereDroit: formData.get('pneuArriereDroit'),
                
                // Commentaires
                commentaires: formData.get('commentaires') || '',
                
                // Photos
                photos: currentPhotos.map(photo => ({
                    id: photo.id,
                    data: photo.data,
                    timestamp: photo.timestamp
                })),
                
                dateCreation: new Date().toISOString()
            };
            
            try {
                await saveControl(data);
                showMessage('success', `Contr√¥le enregistr√© avec succ√®s ! (${currentPhotos.length} photo(s) incluse(s))`);
                resetForm();
                loadControls();
            } catch (error) {
                showMessage('error', 'Erreur lors de l\'enregistrement : ' + error.message);
            }
        });

        function resetForm() {
            document.getElementById('vehicleForm').reset();
            document.getElementById('dateControle').value = new Date().toISOString().split('T')[0];
            updateCheckboxStyles();
            resetPhotos();
        }

        async function loadControls() {
            try {
                const controls = await getAllControls();
                displayControls(controls);
            } catch (error) {
                console.error('Erreur lors du chargement des contr√¥les:', error);
            }
        }

        function displayControls(controls) {
            const container = document.getElementById('controlsList');
            
            if (controls.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <h3>Aucun contr√¥le enregistr√©</h3>
                        <p>Commencez par ajouter un nouveau contr√¥le</p>
                    </div>
                `;
                return;
            }
            
            controls.sort((a, b) => new Date(b.dateControle) - new Date(a.dateControle));
            
            container.innerHTML = controls.map(control => createControlCard(control)).join('');
        }

        function createControlCard(control) {
            const formatDate = (dateStr) => {
                if (!dateStr) return 'Non renseign√©';
                return new Date(dateStr).toLocaleDateString('fr-FR');
            };
            
            const formatKilometrage = (km) => {
                if (!km) return 'Non renseign√©';
                return km + ' km';
            };
            
            const getStatusBadge = (value, type = 'boolean') => {
                if (type === 'boolean') {
                    return value ? 
                        '<span class="status-badge status-ok">‚úì Pr√©sent</span>' :
                        '<span class="status-badge status-missing">‚úó Absent</span>';
                } else {
                    return `<span class="status-badge status-${value}">${value.charAt(0).toUpperCase() + value.slice(1)}</span>`;
                }
            };

            const commentairesSection = control.commentaires && control.commentaires.trim() ? `
                <div class="control-comments">
                    <h5>üí¨ Commentaires</h5>
                    <div class="comment-text" style="background: #f8f9fa; padding: 12px; border-radius: 6px; border-left: 4px solid #007bff; margin-top: 10px; white-space: pre-wrap;">${control.commentaires}</div>
                </div>
            ` : '';

            const photosSection = control.photos && control.photos.length > 0 ? `
                <div class="control-photos">
                    <h5>üì∏ Photos du contr√¥le (${control.photos.length})</h5>
                    <div class="photos-grid">
                        ${control.photos.map((photo, index) => `
                            <img src="${photo.data}" 
                                 alt="Photo ${index + 1}" 
                                 class="photo-thumbnail" 
                                 onclick="viewPhoto('${photo.data}')"
                                 title="Cliquez pour agrandir">
                        `).join('')}
                    </div>
                </div>
            ` : '';
            
            return `
                <div class="control-item">
                    <div class="control-header">
                        <h4>üöó ${control.immatriculation} - ${control.conducteur}</h4>
                        <button class="btn btn-danger" onclick="deleteControlById(${control.id})" style="padding: 8px 15px; font-size: 0.9rem;">
                            üóëÔ∏è Supprimer
                        </button>
                    </div>
                    
                    <div class="control-info">
                        <div class="info-item">
                            <span class="info-label">Date du contr√¥le</span>
                            <span class="info-value">${formatDate(control.dateControle)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Kilom√©trage</span>
                            <span class="info-value">${formatKilometrage(control.kilometrage)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Prochain CT</span>
                            <span class="info-value">${formatDate(control.prochainControle)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Derni√®re r√©vision</span>
                            <span class="info-value">${formatKilometrage(control.derniereRevision)}</span>
                        </div>
                    </div>
                    
                    <h5 style="margin: 15px 0 10px 0;">üìã Documents</h5>
                    <div class="control-info">
                        <div class="info-item">
                            <span class="info-label">Permis</span>
                            ${getStatusBadge(control.permis)}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Carte verte</span>
                            ${getStatusBadge(control.carteVerte)}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Carte grise</span>
                            ${getStatusBadge(control.carteGrise)}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Carte carburant</span>
                            ${getStatusBadge(control.carteCarburant)}
                        </div>
                    </div>
                    
                    <h5 style="margin: 15px 0 10px 0;">üõ°Ô∏è √âquipements</h5>
                    <div class="control-info">
                        <div class="info-item">
                            <span class="info-label">Gilet jaune</span>
                            ${getStatusBadge(control.giletJaune)}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Triangle</span>
                            ${getStatusBadge(control.triangle)}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Roue secours</span>
                            ${getStatusBadge(control.roueSecours)}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Trousse secours</span>
                            ${getStatusBadge(control.trousseSecours)}
                        </div>
                    </div>
                    
                    <h5 style="margin: 15px 0 10px 0;">üîß √âtat g√©n√©ral</h5>
                    <div class="control-info">
                        <div class="info-item">
                            <span class="info-label">Rangement</span>
                            ${getStatusBadge(control.etatRangement, 'state')}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Propret√© int.</span>
                            ${getStatusBadge(control.propret√©Interieur, 'state')}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Propret√© ext.</span>
                            ${getStatusBadge(control.propret√©Exterieur, 'state')}
                        </div>
                    </div>
                    
                    <h5 style="margin: 15px 0 10px 0;">üõû Pneus</h5>
                    <div class="control-info">
                        <div class="info-item">
                            <span class="info-label">Avant gauche</span>
                            ${getStatusBadge(control.pneuAvantGauche, 'state')}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Avant droit</span>
                            ${getStatusBadge(control.pneuAvantDroit, 'state')}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Arri√®re gauche</span>
                            ${getStatusBadge(control.pneuArriereGauche, 'state')}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Arri√®re droit</span>
                            ${getStatusBadge(control.pneuArriereDroit, 'state')}
                        </div>
                    </div>
                    
                    ${commentairesSection}
                    
                    ${photosSection}
                </div>
            `;
        }

        async function deleteControlById(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce contr√¥le ?')) {
                try {
                    await deleteControl(id);
                    showMessage('success', '‚úÖ Contr√¥le supprim√© avec succ√®s !');
                    loadControls();
                } catch (error) {
                    showMessage('error', '‚ùå Erreur lors de la suppression : ' + error.message);
                }
            }
        }

        function filterControls() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const controlItems = document.querySelectorAll('.control-item');
            
            controlItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        async function exportToExcel() {
            const loadingEl = document.getElementById('exportLoading');
            const statusEl = document.getElementById('exportStatus');
            
            try {
                loadingEl.style.display = 'block';
                statusEl.innerHTML = '';
                
                const controls = await getAllControls();
                
                if (controls.length === 0) {
                    throw new Error('Aucune donn√©e √† exporter');
                }
                
                const excelData = controls.map(control => ({
                    'Date contr√¥le': control.dateControle,
                    'Conducteur': control.conducteur,
                    'Immatriculation': control.immatriculation,
                    'Kilom√©trage': control.kilometrage || '',
                    'Prochain CT': control.prochainControle || '',
                    'Derni√®re r√©vision (km)': control.derniereRevision || '',
                    'Permis': control.permis ? 'Oui' : 'Non',
                    'Carte verte': control.carteVerte ? 'Oui' : 'Non',
                    'Carte grise': control.carteGrise ? 'Oui' : 'Non',
                    'Carte carburant': control.carteCarburant ? 'Oui' : 'Non',
                    'Gilet jaune': control.giletJaune ? 'Oui' : 'Non',
                    'Triangle': control.triangle ? 'Oui' : 'Non',
                    'Roue secours': control.roueSecours ? 'Oui' : 'Non',
                    'Trousse secours': control.trousseSecours ? 'Oui' : 'Non',
                    '√âtat rangement': control.etatRangement,
                    'Propret√© int√©rieur': control.propret√©Interieur,
                    'Propret√© ext√©rieur': control.propret√©Exterieur,
                    'Pneu AV G': control.pneuAvantGauche,
                    'Pneu AV D': control.pneuAvantDroit,
                    'Pneu AR G': control.pneuArriereGauche,
                    'Pneu AR D': control.pneuArriereDroit,
                    'Commentaires': control.commentaires || '',
                    'Nb Photos': control.photos ? control.photos.length : 0,
                    'Date cr√©ation': new Date(control.dateCreation).toLocaleDateString('fr-FR')
                }));
                
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                const colWidths = [];
                Object.keys(excelData[0]).forEach(key => {
                    const maxLength = Math.max(
                        key.length,
                        ...excelData.map(row => String(row[key] || '').length)
                    );
                    colWidths.push({ width: Math.min(maxLength + 2, 50) });
                });
                ws['!cols'] = colWidths;
                
                XLSX.utils.book_append_sheet(wb, ws, 'Contr√¥les V√©hicules');
                
                const fileName = `Controles_Vehicules_GazService_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                statusEl.innerHTML = `<div class="success-message">‚úÖ Fichier "${fileName}" t√©l√©charg√© avec succ√®s !</div>`;
                
            } catch (error) {
                statusEl.innerHTML = `<div class="error-message">‚ùå Erreur lors de l'export : ${error.message}</div>`;
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        function showMessage(type, message) {
            const messageEl = document.createElement('div');
            messageEl.className = `${type}-message`;
            messageEl.textContent = message;
            messageEl.style.position = 'fixed';
            messageEl.style.top = '20px';
            messageEl.style.right = '20px';
            messageEl.style.zIndex = '1000';
            messageEl.style.maxWidth = '400px';
            
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                messageEl.remove();
            }, 5000);
        }

        function updateCheckboxStyles() {
            document.querySelectorAll('.checkbox-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox.checked) {
                    item.classList.add('checked');
                } else {
                    item.classList.remove('checked');
                }
            });
        }

        document.addEventListener('change', function(e) {
            if (e.target.type === 'checkbox') {
                updateCheckboxStyles();
            }
        });

        function formatImmatriculation(value) {
            value = value.replace(/[^A-Za-z0-9]/g, '').toUpperCase();
            
            if (value.length > 7) {
                value = value.substring(0, 7);
            }
            
            if (value.length >= 5) {
                return value.substring(0, 2) + '-' + value.substring(2, 5) + '-' + value.substring(5);
            } else if (value.length >= 2) {
                return value.substring(0, 2) + '-' + value.substring(2);
            }
            
            return value;
        }

        function validateImmatriculation(value) {
            const regex = /^[A-Z]{2}-[0-9]{3}-[A-Z]{2}$/;
            return regex.test(value);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const immatriculationField = document.getElementById('immatriculation');
            const conducteurField = document.getElementById('conducteur');
            
            if (immatriculationField) {
                immatriculationField.addEventListener('input', function(e) {
                    const cursorPosition = e.target.selectionStart;
                    const oldValue = e.target.value;
                    const newValue = formatImmatriculation(e.target.value);
                    
                    e.target.value = newValue;
                    
                    const newCursorPosition = cursorPosition + (newValue.length - oldValue.length);
                    e.target.setSelectionRange(newCursorPosition, newCursorPosition);
                    
                    if (newValue.length === 9 && validateImmatriculation(newValue)) {
                        e.target.style.borderColor = '#28a745';
                        e.target.style.backgroundColor = '#f8fff9';
                    } else if (newValue.length > 0) {
                        e.target.style.borderColor = '#ffc107';
                        e.target.style.backgroundColor = '#fffdf0';
                    } else {
                        e.target.style.borderColor = '#bdc3c7';
                        e.target.style.backgroundColor = '#ffffff';
                    }
                });

                immatriculationField.addEventListener('blur', function(e) {
                    if (e.target.value && !validateImmatriculation(e.target.value)) {
                        e.target.style.borderColor = '#dc3545';
                        e.target.style.backgroundColor = '#fff5f5';
                        showMessage('warning', 'Format d\'immatriculation invalide. Utilisez le format AA-000-AA');
                    }
                });
            }

            if (conducteurField) {
                conducteurField.addEventListener('input', function(e) {
                    const cursorPosition = e.target.selectionStart;
                    const newValue = e.target.value.toUpperCase();
                    
                    e.target.value = newValue;
                    
                    e.target.setSelectionRange(cursorPosition, cursorPosition);
                });
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            const importSection = document.getElementById('importSection');
            
            if (importSection) {
                importSection.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    importSection.classList.add('drag-over');
                });
                
                importSection.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    importSection.classList.remove('drag-over');
                });
                
                importSection.addEventListener('drop', function(e) {
                    e.preventDefault();
                    importSection.classList.remove('drag-over');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const fileInput = document.getElementById('vehicleListFile');
                        fileInput.files = files;
                        handleVehicleListFile(fileInput);
                    }
                });
            }
        });

        document.addEventListener('DOMContentLoaded', async function() {
            try {
                await initDB();
                console.log('Base de donn√©es initialis√©e avec succ√®s');
                
                // Diagnostic IndexedDB
                const dbInfo = await diagnoseIndexedDB();
                console.log('Diagnostic IndexedDB:', dbInfo);
                
                if (dbInfo.quota) {
                    console.log(`Stockage: ${formatBytes(dbInfo.used)} utilis√© sur ${formatBytes(dbInfo.quota)} (${dbInfo.percentUsed}%)`);
                }
                
                document.getElementById('dateControle').value = new Date().toISOString().split('T')[0];
                
                updatePhotoPreview();
                
                loadControls();
                
                // Afficher les informations sur les sauvegardes disponibles
                const backups = await listAllBackups();
                const latestBackup = backups.find(b => b.type === 'auto');
                
                if (latestBackup) {
                    const autoBackupStatus = document.getElementById('autoBackupStatus');
                    if (autoBackupStatus) {
                        const controls = latestBackup.data.controls ? latestBackup.data.controls.length : 0;
                        const vehicles = latestBackup.data.vehicles ? latestBackup.data.vehicles.length : 0;
                        const alerts = latestBackup.data.alerts ? latestBackup.data.alerts.length : 0;
                        const photos = latestBackup.stats ? latestBackup.stats.totalPhotos || 0 : 0;
                        
                        autoBackupStatus.innerHTML = `
                            <div class="info-message">
                                Sauvegarde auto disponible: ${controls} contr√¥les, ${vehicles} v√©hicules, ${alerts} alertes, ${photos} photos<br>
                                Cr√©√©e le: ${new Date(latestBackup.timestamp).toLocaleString('fr-FR')}<br>
                                Stock√©e en IndexedDB (${formatBytes(JSON.stringify(latestBackup).length)})
                            </div>
                        `;
                    }
                }
                
            } catch (error) {
                console.error('Erreur lors de l\'initialisation:', error);
                showMessage('error', 'Erreur d\'initialisation de la base de donn√©es');
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const cameraModal = document.getElementById('cameraModal');
                if (cameraModal.style.display === 'flex') {
                    closeCamera();
                }
                
                const photoViewer = document.querySelector('.photo-viewer-modal');
                if (photoViewer) {
                    photoViewer.remove();
                }
            }
        });
    </script>
</body>
</html>